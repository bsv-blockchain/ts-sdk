<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="TypeScript SDK for Bitcoin SV"><link href=https://bitcoin-sv.github.io/ts-sdk/tutorials/type-42/ rel=canonical><link href=../hashes-and-hmacs/ rel=prev><link href=../advanced-transaction/ rel=next><link rel=icon href=../../assets/images/favicon.png><meta name=generator content="mkdocs-1.6.1, mkdocs-material-9.6.15"><title>Type-42 Key Derivation - BSV TypeScript SDK</title><link rel=stylesheet href=../../assets/stylesheets/main.342714a4.min.css><link rel=stylesheet href=../../assets/stylesheets/palette.06af60db.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#type-42-key-derivation class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class="md-header md-header--shadow" data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../.. title="BSV TypeScript SDK" class="md-header__button md-logo" aria-label="BSV TypeScript SDK" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> BSV TypeScript SDK </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Type-42 Key Derivation </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo aria-label="Switch to dark mode" type=radio name=__palette id=__palette_0> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg> </label> <input class=md-option data-md-color-media data-md-color-scheme=slate data-md-color-primary=indigo data-md-color-accent=indigo aria-label="Switch to light mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_0 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg> </label> </form> <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </label> <nav class=md-search__options aria-label=Search> <a href=javascript:void(0) class="md-search__icon md-icon" title=Share aria-label=Share data-clipboard data-clipboard-text data-md-component=search-share tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg> </a> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> </button> </nav> </form> <div class=md-search__output> <div class=md-search__scrollwrap tabindex=0 data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/bitcoin-sv/ts-sdk title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg> </div> <div class=md-source__repository> bitcoin-sv/ts-sdk </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../.. title="BSV TypeScript SDK" class="md-nav__button md-logo" aria-label="BSV TypeScript SDK" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg> </a> BSV TypeScript SDK </label> <div class=md-nav__source> <a href=https://github.com/bitcoin-sv/ts-sdk title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg> </div> <div class=md-source__repository> bitcoin-sv/ts-sdk </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../.. class=md-nav__link> <span class=md-ellipsis> Home </span> </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2 checked> <div class="md-nav__link md-nav__container"> <a href=../ class="md-nav__link "> <span class=md-ellipsis> Tutorials </span> </a> <label class="md-nav__link " for=__nav_2 id=__nav_2_label tabindex=0> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_2_label aria-expanded=true> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> Tutorials </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_2_2> <label class=md-nav__link for=__nav_2_2 id=__nav_2_2_label tabindex=0> <span class=md-ellipsis> Getting Started </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_2_label aria-expanded=false> <label class=md-nav__title for=__nav_2_2> <span class="md-nav__icon md-icon"></span> Getting Started </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../first-transaction/ class=md-nav__link> <span class=md-ellipsis> First Transaction </span> </a> </li> <li class=md-nav__item> <a href=../key-management/ class=md-nav__link> <span class=md-ellipsis> Key Management </span> </a> </li> <li class=md-nav__item> <a href=../transaction-broadcasting/ class=md-nav__link> <span class=md-ellipsis> Transaction Broadcasting </span> </a> </li> <li class=md-nav__item> <a href=../transaction-types/ class=md-nav__link> <span class=md-ellipsis> Transaction Types </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_3 checked> <label class=md-nav__link for=__nav_2_3 id=__nav_2_3_label tabindex=0> <span class=md-ellipsis> Cryptography </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_3_label aria-expanded=true> <label class=md-nav__title for=__nav_2_3> <span class="md-nav__icon md-icon"></span> Cryptography </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../aes-encryption/ class=md-nav__link> <span class=md-ellipsis> AES Encryption </span> </a> </li> <li class=md-nav__item> <a href=../ecdh-key-exchange/ class=md-nav__link> <span class=md-ellipsis> ECDH Key Exchange </span> </a> </li> <li class=md-nav__item> <a href=../elliptic-curve-fundamentals/ class=md-nav__link> <span class=md-ellipsis> Elliptic Curve Fundamentals </span> </a> </li> <li class=md-nav__item> <a href=../hashes-and-hmacs/ class=md-nav__link> <span class=md-ellipsis> Hashes and HMACs </span> </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> <span class=md-ellipsis> Type-42 Key Derivation </span> <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> <span class=md-ellipsis> Type-42 Key Derivation </span> </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#learning-goals class=md-nav__link> <span class=md-ellipsis> Learning Goals </span> </a> </li> <li class=md-nav__item> <a href=#introduction-to-type-42 class=md-nav__link> <span class=md-ellipsis> Introduction to Type-42 </span> </a> </li> <li class=md-nav__item> <a href=#setting-up-your-environment class=md-nav__link> <span class=md-ellipsis> Setting Up Your Environment </span> </a> </li> <li class=md-nav__item> <a href=#understanding-type-42-process class=md-nav__link> <span class=md-ellipsis> Understanding Type-42 Process </span> </a> <nav class=md-nav aria-label="Understanding Type-42 Process"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#the-mathematical-foundation class=md-nav__link> <span class=md-ellipsis> The Mathematical Foundation </span> </a> </li> <li class=md-nav__item> <a href=#security-properties class=md-nav__link> <span class=md-ellipsis> Security Properties </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#basic-type-42-implementation class=md-nav__link> <span class=md-ellipsis> Basic Type-42 Implementation </span> </a> <nav class=md-nav aria-label="Basic Type-42 Implementation"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#step-1-master-key-setup class=md-nav__link> <span class=md-ellipsis> Step 1: Master Key Setup </span> </a> </li> <li class=md-nav__item> <a href=#step-2-invoice-number-agreement class=md-nav__link> <span class=md-ellipsis> Step 2: Invoice Number Agreement </span> </a> </li> <li class=md-nav__item> <a href=#step-3-child-key-derivation class=md-nav__link> <span class=md-ellipsis> Step 3: Child Key Derivation </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#practical-example-message-signing class=md-nav__link> <span class=md-ellipsis> Practical Example: Message Signing </span> </a> </li> <li class=md-nav__item> <a href=#bidirectional-communication class=md-nav__link> <span class=md-ellipsis> Bidirectional Communication </span> </a> </li> <li class=md-nav__item> <a href=#the-anyone-key-concept class=md-nav__link> <span class=md-ellipsis> The "Anyone Key" Concept </span> </a> </li> <li class=md-nav__item> <a href=#advanced-type-42-applications class=md-nav__link> <span class=md-ellipsis> Advanced Type-42 Applications </span> </a> <nav class=md-nav aria-label="Advanced Type-42 Applications"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#multi-purpose-key-derivation class=md-nav__link> <span class=md-ellipsis> Multi-Purpose Key Derivation </span> </a> </li> <li class=md-nav__item> <a href=#session-based-key-derivation class=md-nav__link> <span class=md-ellipsis> Session-Based Key Derivation </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#integration-with-transactions class=md-nav__link> <span class=md-ellipsis> Integration with Transactions </span> </a> </li> <li class=md-nav__item> <a href=#error-handling-and-validation class=md-nav__link> <span class=md-ellipsis> Error Handling and Validation </span> </a> </li> <li class=md-nav__item> <a href=#performance-considerations class=md-nav__link> <span class=md-ellipsis> Performance Considerations </span> </a> <nav class=md-nav aria-label="Performance Considerations"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#caching-derived-keys class=md-nav__link> <span class=md-ellipsis> Caching Derived Keys </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#security-best-practices class=md-nav__link> <span class=md-ellipsis> Security Best Practices </span> </a> <nav class=md-nav aria-label="Security Best Practices"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#1-invoice-number-guidelines class=md-nav__link> <span class=md-ellipsis> 1. Invoice Number Guidelines </span> </a> </li> <li class=md-nav__item> <a href=#2-master-key-protection class=md-nav__link> <span class=md-ellipsis> 2. Master Key Protection </span> </a> </li> <li class=md-nav__item> <a href=#3-counterparty-validation class=md-nav__link> <span class=md-ellipsis> 3. Counterparty Validation </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#testing-type-42-implementation class=md-nav__link> <span class=md-ellipsis> Testing Type-42 Implementation </span> </a> </li> <li class=md-nav__item> <a href=#troubleshooting-common-issues class=md-nav__link> <span class=md-ellipsis> Troubleshooting Common Issues </span> </a> <nav class=md-nav aria-label="Troubleshooting Common Issues"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#issue-1-key-mismatch class=md-nav__link> <span class=md-ellipsis> Issue 1: Key Mismatch </span> </a> </li> <li class=md-nav__item> <a href=#issue-2-invalid-public-key class=md-nav__link> <span class=md-ellipsis> Issue 2: Invalid Public Key </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#conclusion class=md-nav__link> <span class=md-ellipsis> Conclusion </span> </a> </li> <li class=md-nav__item> <a href=#further-reading class=md-nav__link> <span class=md-ellipsis> Further Reading </span> </a> </li> <li class=md-nav__item> <a href=#integration-with-walletclient class=md-nav__link> <span class=md-ellipsis> Integration with WalletClient </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_2_4> <label class=md-nav__link for=__nav_2_4 id=__nav_2_4_label tabindex=0> <span class=md-ellipsis> Advanced Topics </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_4_label aria-expanded=false> <label class=md-nav__title for=__nav_2_4> <span class="md-nav__icon md-icon"></span> Advanced Topics </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../advanced-transaction/ class=md-nav__link> <span class=md-ellipsis> Advanced Transaction Construction </span> </a> </li> <li class=md-nav__item> <a href=../script-construction/ class=md-nav__link> <span class=md-ellipsis> Script Construction </span> </a> </li> <li class=md-nav__item> <a href=../spv-merkle-proofs/ class=md-nav__link> <span class=md-ellipsis> SPV and Merkle Proofs </span> </a> </li> <li class=md-nav__item> <a href=../error-handling/ class=md-nav__link> <span class=md-ellipsis> Error Handling </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_2_5> <label class=md-nav__link for=__nav_2_5 id=__nav_2_5_label tabindex=0> <span class=md-ellipsis> Low-Level APIs </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_5_label aria-expanded=false> <label class=md-nav__title for=__nav_2_5> <span class="md-nav__icon md-icon"></span> Low-Level APIs </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../first-transaction-low-level/ class=md-nav__link> <span class=md-ellipsis> First Transaction (Low-Level) </span> </a> </li> <li class=md-nav__item> <a href=../testnet-transactions-low-level/ class=md-nav__link> <span class=md-ellipsis> Testnet Transactions (Low-Level) </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_2_6> <label class=md-nav__link for=__nav_2_6 id=__nav_2_6_label tabindex=0> <span class=md-ellipsis> Specialized Tools </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_6_label aria-expanded=false> <label class=md-nav__title for=__nav_2_6> <span class="md-nav__icon md-icon"></span> Specialized Tools </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../authfetch-tutorial/ class=md-nav__link> <span class=md-ellipsis> AuthFetch Tutorial </span> </a> </li> <li class=md-nav__item> <a href=../identity-management/ class=md-nav__link> <span class=md-ellipsis> Identity Management </span> </a> </li> <li class=md-nav__item> <a href=../protowallet-development/ class=md-nav__link> <span class=md-ellipsis> ProtoWallet Development </span> </a> </li> <li class=md-nav__item> <a href=../uhrp-storage/ class=md-nav__link> <span class=md-ellipsis> UHRP Storage </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_3> <div class="md-nav__link md-nav__container"> <a href=../../guides/ class="md-nav__link "> <span class=md-ellipsis> How-to Guides </span> </a> <label class="md-nav__link " for=__nav_3 id=__nav_3_label tabindex=0> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_3_label aria-expanded=false> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> How-to Guides </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_3_2> <label class=md-nav__link for=__nav_3_2 id=__nav_3_2_label tabindex=0> <span class=md-ellipsis> Transaction Management </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_2_label aria-expanded=false> <label class=md-nav__title for=__nav_3_2> <span class="md-nav__icon md-icon"></span> Transaction Management </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../guides/advanced-transaction-signing.md class=md-nav__link> <span class=md-ellipsis> Advanced Transaction Signing </span> </a> </li> <li class=md-nav__item> <a href=../../guides/direct-transaction-creation/ class=md-nav__link> <span class=md-ellipsis> Direct Transaction Creation </span> </a> </li> <li class=md-nav__item> <a href=../../guides/large-transactions.md class=md-nav__link> <span class=md-ellipsis> Large Transactions </span> </a> </li> <li class=md-nav__item> <a href=../../guides/multisig-transactions.md class=md-nav__link> <span class=md-ellipsis> Multi-signature Transactions </span> </a> </li> <li class=md-nav__item> <a href=../../guides/transaction-batching.md class=md-nav__link> <span class=md-ellipsis> Transaction Batching </span> </a> </li> <li class=md-nav__item> <a href=../../guides/transaction-monitoring.md class=md-nav__link> <span class=md-ellipsis> Transaction Monitoring </span> </a> </li> <li class=md-nav__item> <a href=../../guides/transaction-signing-methods/ class=md-nav__link> <span class=md-ellipsis> Transaction Signing Methods </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_3_3> <label class=md-nav__link for=__nav_3_3 id=__nav_3_3_label tabindex=0> <span class=md-ellipsis> Cryptographic Operations </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_3_label aria-expanded=false> <label class=md-nav__title for=__nav_3_3> <span class="md-nav__icon md-icon"></span> Cryptographic Operations </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../guides/security-best-practices.md class=md-nav__link> <span class=md-ellipsis> Security Best Practices </span> </a> </li> <li class=md-nav__item> <a href=../../guides/complex-signatures.md class=md-nav__link> <span class=md-ellipsis> Complex Signatures </span> </a> </li> <li class=md-nav__item> <a href=../../guides/custom-key-derivation.md class=md-nav__link> <span class=md-ellipsis> Custom Key Derivation </span> </a> </li> <li class=md-nav__item> <a href=../../guides/encrypted-messages.md class=md-nav__link> <span class=md-ellipsis> Encrypted Messages </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_3_4> <label class=md-nav__link for=__nav_3_4 id=__nav_3_4_label tabindex=0> <span class=md-ellipsis> Network and Broadcasting </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_4_label aria-expanded=false> <label class=md-nav__title for=__nav_3_4> <span class="md-nav__icon md-icon"></span> Network and Broadcasting </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../guides/chain-tracking.md class=md-nav__link> <span class=md-ellipsis> Chain Tracking </span> </a> </li> <li class=md-nav__item> <a href=../../guides/custom-broadcasters.md class=md-nav__link> <span class=md-ellipsis> Custom Broadcasters </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_3_5> <label class=md-nav__link for=__nav_3_5 id=__nav_3_5_label tabindex=0> <span class=md-ellipsis> Authentication and Communication </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_5_label aria-expanded=false> <label class=md-nav__title for=__nav_3_5> <span class="md-nav__icon md-icon"></span> Authentication and Communication </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../guides/authenticated-api-communication.md class=md-nav__link> <span class=md-ellipsis> Authenticated API Communication </span> </a> </li> <li class=md-nav__item> <a href=../../guides/http-client-configuration/ class=md-nav__link> <span class=md-ellipsis> HTTP Client Configuration </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_3_6> <label class=md-nav__link for=__nav_3_6 id=__nav_3_6_label tabindex=0> <span class=md-ellipsis> Development and Integration </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_6_label aria-expanded=false> <label class=md-nav__title for=__nav_3_6> <span class="md-nav__icon md-icon"></span> Development and Integration </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../guides/development-wallet-setup.md class=md-nav__link> <span class=md-ellipsis> Development Wallet Setup </span> </a> </li> <li class=md-nav__item> <a href=../../guides/react-integration.md class=md-nav__link> <span class=md-ellipsis> React Integration </span> </a> </li> <li class=md-nav__item> <a href=../../guides/identity-verification-systems.md class=md-nav__link> <span class=md-ellipsis> Identity Verification Systems </span> </a> </li> <li class=md-nav__item> <a href=../../guides/file-upload-download.md class=md-nav__link> <span class=md-ellipsis> File Upload/Download </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_4> <div class="md-nav__link md-nav__container"> <a href=../../reference/ class="md-nav__link "> <span class=md-ellipsis> Reference </span> </a> <label class="md-nav__link " for=__nav_4 id=__nav_4_label tabindex=0> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_4_label aria-expanded=false> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> Reference </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_4_2> <label class=md-nav__link for=__nav_4_2 id=__nav_4_2_label tabindex=0> <span class=md-ellipsis> Standards and Interfaces </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_4_2_label aria-expanded=false> <label class=md-nav__title for=__nav_4_2> <span class="md-nav__icon md-icon"></span> Standards and Interfaces </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../reference/brc-100/ class=md-nav__link> <span class=md-ellipsis> BRC-100 Wallet Interface </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_4_3> <label class=md-nav__link for=__nav_4_3 id=__nav_4_3_label tabindex=0> <span class=md-ellipsis> Core Classes </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_4_3_label aria-expanded=false> <label class=md-nav__title for=__nav_4_3> <span class="md-nav__icon md-icon"></span> Core Classes </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../reference/primitives/ class=md-nav__link> <span class=md-ellipsis> Primitives </span> </a> </li> <li class=md-nav__item> <a href=../../reference/script/ class=md-nav__link> <span class=md-ellipsis> Script </span> </a> </li> <li class=md-nav__item> <a href=../../reference/transaction/ class=md-nav__link> <span class=md-ellipsis> Transaction </span> </a> </li> <li class=md-nav__item> <a href=../../reference/transaction-signatures/ class=md-nav__link> <span class=md-ellipsis> Transaction Signatures </span> </a> </li> <li class=md-nav__item> <a href=../../reference/op-codes/ class=md-nav__link> <span class=md-ellipsis> OP Codes </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_4_4> <label class=md-nav__link for=__nav_4_4 id=__nav_4_4_label tabindex=0> <span class=md-ellipsis> Module Reference </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_4_4_label aria-expanded=false> <label class=md-nav__title for=__nav_4_4> <span class="md-nav__icon md-icon"></span> Module Reference </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../reference/auth/ class=md-nav__link> <span class=md-ellipsis> Auth </span> </a> </li> <li class=md-nav__item> <a href=../../reference/compat/ class=md-nav__link> <span class=md-ellipsis> Compat </span> </a> </li> <li class=md-nav__item> <a href=../../reference/identity/ class=md-nav__link> <span class=md-ellipsis> Identity </span> </a> </li> <li class=md-nav__item> <a href=../../reference/kvstore/ class=md-nav__link> <span class=md-ellipsis> KV Store </span> </a> </li> <li class=md-nav__item> <a href=../../reference/messages/ class=md-nav__link> <span class=md-ellipsis> Messages </span> </a> </li> <li class=md-nav__item> <a href=../../reference/overlay-tools/ class=md-nav__link> <span class=md-ellipsis> Overlay Tools </span> </a> </li> <li class=md-nav__item> <a href=../../reference/registry/ class=md-nav__link> <span class=md-ellipsis> Registry </span> </a> </li> <li class=md-nav__item> <a href=../../reference/storage/ class=md-nav__link> <span class=md-ellipsis> Storage </span> </a> </li> <li class=md-nav__item> <a href=../../reference/totp/ class=md-nav__link> <span class=md-ellipsis> TOTP </span> </a> </li> <li class=md-nav__item> <a href=../../reference/wallet/ class=md-nav__link> <span class=md-ellipsis> Wallet </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_4_5> <label class=md-nav__link for=__nav_4_5 id=__nav_4_5_label tabindex=0> <span class=md-ellipsis> Configuration </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_4_5_label aria-expanded=false> <label class=md-nav__title for=__nav_4_5> <span class="md-nav__icon md-icon"></span> Configuration </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../reference/arc-config/ class=md-nav__link> <span class=md-ellipsis> ARC Config </span> </a> </li> <li class=md-nav__item> <a href=../../reference/configuration/ class=md-nav__link> <span class=md-ellipsis> Configuration </span> </a> </li> <li class=md-nav__item> <a href=../../reference/network-config/ class=md-nav__link> <span class=md-ellipsis> Network Config </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_4_6> <label class=md-nav__link for=__nav_4_6 id=__nav_4_6_label tabindex=0> <span class=md-ellipsis> Development </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_4_6_label aria-expanded=false> <label class=md-nav__title for=__nav_4_6> <span class="md-nav__icon md-icon"></span> Development </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../reference/debugging/ class=md-nav__link> <span class=md-ellipsis> Debugging </span> </a> </li> <li class=md-nav__item> <a href=../../reference/errors/ class=md-nav__link> <span class=md-ellipsis> Errors </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_5> <div class="md-nav__link md-nav__container"> <a href=../../concepts/ class="md-nav__link "> <span class=md-ellipsis> Concepts </span> </a> <label class="md-nav__link " for=__nav_5 id=__nav_5_label tabindex=0> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_5_label aria-expanded=false> <label class=md-nav__title for=__nav_5> <span class="md-nav__icon md-icon"></span> Concepts </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_5_2> <label class=md-nav__link for=__nav_5_2 id=__nav_5_2_label tabindex=0> <span class=md-ellipsis> Core Concepts </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_5_2_label aria-expanded=false> <label class=md-nav__title for=__nav_5_2> <span class="md-nav__icon md-icon"></span> Core Concepts </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../concepts/sdk-philosophy/ class=md-nav__link> <span class=md-ellipsis> SDK Philosophy </span> </a> </li> <li class=md-nav__item> <a href=../../concepts/transaction-structure/ class=md-nav__link> <span class=md-ellipsis> Transaction Structure </span> </a> </li> <li class=md-nav__item> <a href=../../concepts/transaction-encoding/ class=md-nav__link> <span class=md-ellipsis> Transaction Encoding </span> </a> </li> <li class=md-nav__item> <a href=../../concepts/key-management/ class=md-nav__link> <span class=md-ellipsis> Key Management </span> </a> </li> <li class=md-nav__item> <a href=../../concepts/wallet-integration/ class=md-nav__link> <span class=md-ellipsis> Wallet Integration </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_5_3> <label class=md-nav__link for=__nav_5_3 id=__nav_5_3_label tabindex=0> <span class=md-ellipsis> Bitcoin Protocol </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_5_3_label aria-expanded=false> <label class=md-nav__title for=__nav_5_3> <span class="md-nav__icon md-icon"></span> Bitcoin Protocol </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../concepts/beef/ class=md-nav__link> <span class=md-ellipsis> BEEF </span> </a> </li> <li class=md-nav__item> <a href=../../concepts/script-templates/ class=md-nav__link> <span class=md-ellipsis> Script Templates </span> </a> </li> <li class=md-nav__item> <a href=../../concepts/signatures/ class=md-nav__link> <span class=md-ellipsis> Signatures </span> </a> </li> <li class=md-nav__item> <a href=../../concepts/fees/ class=md-nav__link> <span class=md-ellipsis> Fees </span> </a> </li> <li class=md-nav__item> <a href=../../concepts/verification/ class=md-nav__link> <span class=md-ellipsis> Verification </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_5_4> <label class=md-nav__link for=__nav_5_4 id=__nav_5_4_label tabindex=0> <span class=md-ellipsis> Architecture </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_5_4_label aria-expanded=false> <label class=md-nav__title for=__nav_5_4> <span class="md-nav__icon md-icon"></span> Architecture </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../concepts/chain-tracking/ class=md-nav__link> <span class=md-ellipsis> Chain Tracking </span> </a> </li> <li class=md-nav__item> <a href=../../concepts/spv-verification/ class=md-nav__link> <span class=md-ellipsis> SPV Verification </span> </a> </li> <li class=md-nav__item> <a href=../../concepts/trust-model/ class=md-nav__link> <span class=md-ellipsis> Trust Model </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_5_5> <label class=md-nav__link for=__nav_5_5 id=__nav_5_5_label tabindex=0> <span class=md-ellipsis> Identity and Certificates </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_5_5_label aria-expanded=false> <label class=md-nav__title for=__nav_5_5> <span class="md-nav__icon md-icon"></span> Identity and Certificates </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../concepts/decentralized-identity/ class=md-nav__link> <span class=md-ellipsis> Decentralized Identity </span> </a> </li> <li class=md-nav__item> <a href=../../concepts/identity-certificates/ class=md-nav__link> <span class=md-ellipsis> Identity Certificates </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_6> <div class="md-nav__link md-nav__container"> <a href=../../swagger/ class="md-nav__link "> <span class=md-ellipsis> API Documentation </span> </a> </div> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_6_label aria-expanded=false> <label class=md-nav__title for=__nav_6> <span class="md-nav__icon md-icon"></span> API Documentation </label> <ul class=md-nav__list data-md-scrollfix> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#learning-goals class=md-nav__link> <span class=md-ellipsis> Learning Goals </span> </a> </li> <li class=md-nav__item> <a href=#introduction-to-type-42 class=md-nav__link> <span class=md-ellipsis> Introduction to Type-42 </span> </a> </li> <li class=md-nav__item> <a href=#setting-up-your-environment class=md-nav__link> <span class=md-ellipsis> Setting Up Your Environment </span> </a> </li> <li class=md-nav__item> <a href=#understanding-type-42-process class=md-nav__link> <span class=md-ellipsis> Understanding Type-42 Process </span> </a> <nav class=md-nav aria-label="Understanding Type-42 Process"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#the-mathematical-foundation class=md-nav__link> <span class=md-ellipsis> The Mathematical Foundation </span> </a> </li> <li class=md-nav__item> <a href=#security-properties class=md-nav__link> <span class=md-ellipsis> Security Properties </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#basic-type-42-implementation class=md-nav__link> <span class=md-ellipsis> Basic Type-42 Implementation </span> </a> <nav class=md-nav aria-label="Basic Type-42 Implementation"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#step-1-master-key-setup class=md-nav__link> <span class=md-ellipsis> Step 1: Master Key Setup </span> </a> </li> <li class=md-nav__item> <a href=#step-2-invoice-number-agreement class=md-nav__link> <span class=md-ellipsis> Step 2: Invoice Number Agreement </span> </a> </li> <li class=md-nav__item> <a href=#step-3-child-key-derivation class=md-nav__link> <span class=md-ellipsis> Step 3: Child Key Derivation </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#practical-example-message-signing class=md-nav__link> <span class=md-ellipsis> Practical Example: Message Signing </span> </a> </li> <li class=md-nav__item> <a href=#bidirectional-communication class=md-nav__link> <span class=md-ellipsis> Bidirectional Communication </span> </a> </li> <li class=md-nav__item> <a href=#the-anyone-key-concept class=md-nav__link> <span class=md-ellipsis> The "Anyone Key" Concept </span> </a> </li> <li class=md-nav__item> <a href=#advanced-type-42-applications class=md-nav__link> <span class=md-ellipsis> Advanced Type-42 Applications </span> </a> <nav class=md-nav aria-label="Advanced Type-42 Applications"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#multi-purpose-key-derivation class=md-nav__link> <span class=md-ellipsis> Multi-Purpose Key Derivation </span> </a> </li> <li class=md-nav__item> <a href=#session-based-key-derivation class=md-nav__link> <span class=md-ellipsis> Session-Based Key Derivation </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#integration-with-transactions class=md-nav__link> <span class=md-ellipsis> Integration with Transactions </span> </a> </li> <li class=md-nav__item> <a href=#error-handling-and-validation class=md-nav__link> <span class=md-ellipsis> Error Handling and Validation </span> </a> </li> <li class=md-nav__item> <a href=#performance-considerations class=md-nav__link> <span class=md-ellipsis> Performance Considerations </span> </a> <nav class=md-nav aria-label="Performance Considerations"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#caching-derived-keys class=md-nav__link> <span class=md-ellipsis> Caching Derived Keys </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#security-best-practices class=md-nav__link> <span class=md-ellipsis> Security Best Practices </span> </a> <nav class=md-nav aria-label="Security Best Practices"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#1-invoice-number-guidelines class=md-nav__link> <span class=md-ellipsis> 1. Invoice Number Guidelines </span> </a> </li> <li class=md-nav__item> <a href=#2-master-key-protection class=md-nav__link> <span class=md-ellipsis> 2. Master Key Protection </span> </a> </li> <li class=md-nav__item> <a href=#3-counterparty-validation class=md-nav__link> <span class=md-ellipsis> 3. Counterparty Validation </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#testing-type-42-implementation class=md-nav__link> <span class=md-ellipsis> Testing Type-42 Implementation </span> </a> </li> <li class=md-nav__item> <a href=#troubleshooting-common-issues class=md-nav__link> <span class=md-ellipsis> Troubleshooting Common Issues </span> </a> <nav class=md-nav aria-label="Troubleshooting Common Issues"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#issue-1-key-mismatch class=md-nav__link> <span class=md-ellipsis> Issue 1: Key Mismatch </span> </a> </li> <li class=md-nav__item> <a href=#issue-2-invalid-public-key class=md-nav__link> <span class=md-ellipsis> Issue 2: Invalid Public Key </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#conclusion class=md-nav__link> <span class=md-ellipsis> Conclusion </span> </a> </li> <li class=md-nav__item> <a href=#further-reading class=md-nav__link> <span class=md-ellipsis> Further Reading </span> </a> </li> <li class=md-nav__item> <a href=#integration-with-walletclient class=md-nav__link> <span class=md-ellipsis> Integration with WalletClient </span> </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1 id=type-42-key-derivation>Type-42 Key Derivation</h1> <p><strong>Duration</strong>: 75 minutes<br> <strong>Prerequisites</strong>: Basic TypeScript knowledge, Elliptic Curve Fundamentals tutorial completed, ECDH Key Exchange tutorial completed</p> <h2 id=learning-goals>Learning Goals</h2> <ul> <li>Understand Type-42 key derivation protocol and its use cases</li> <li>Implement Type-42 operations with the BSV TypeScript SDK</li> <li>Create shared key universes between two parties</li> <li>Apply Type-42 in practical Bitcoin applications like message signing and encryption</li> <li>Understand the "anyone key" concept and its applications</li> </ul> <h2 id=introduction-to-type-42>Introduction to Type-42</h2> <p>Type-42 is a key derivation protocol that enables two parties with master keys to derive child keys from one another using a specific string called an "invoice number." This creates a shared key universe that only these two parties can access, enabling secure communication and transactions without revealing their master keys.</p> <p>The protocol gets its name from its historical use in Bitcoin payment systems, where invoice numbers were used to generate unique keys for each transaction. However, Type-42 has broader applications in secure messaging, authentication, and any scenario requiring shared key derivation.</p> <h2 id=setting-up-your-environment>Setting Up Your Environment</h2> <div class=highlight><pre><span></span><code><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>PrivateKey</span><span class=p>,</span><span class=w> </span><span class=nx>PublicKey</span><span class=p>,</span><span class=w> </span><span class=nx>Utils</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;@bsv/sdk&#39;</span>
</code></pre></div> <h2 id=understanding-type-42-process>Understanding Type-42 Process</h2> <h3 id=the-mathematical-foundation>The Mathematical Foundation</h3> <p>Type-42 key derivation follows these steps:</p> <ol> <li><strong>Master Key Generation</strong>: Each party generates a master private key</li> <li><strong>Public Key Exchange</strong>: Parties share their master public keys</li> <li><strong>Shared Secret Creation</strong>: Using ECDH, parties compute a shared secret</li> <li><strong>Invoice Number Agreement</strong>: Parties agree on a unique identifier (invoice number)</li> <li><strong>HMAC Computation</strong>: The shared secret is used as an HMAC key to hash the invoice number</li> <li><strong>Key Derivation</strong>: The HMAC output is used to derive child keys</li> </ol> <h3 id=security-properties>Security Properties</h3> <ul> <li>Only the two parties can compute the shared secret</li> <li>Only they can use the HMAC function with their shared secret</li> <li>No one else can link master keys to derived keys</li> <li>Each invoice number creates a unique key pair in their shared universe</li> </ul> <h2 id=basic-type-42-implementation>Basic Type-42 Implementation</h2> <h3 id=step-1-master-key-setup>Step 1: Master Key Setup</h3> <div class=highlight><pre><span></span><code><a id=__codelineno-1-1 name=__codelineno-1-1 href=#__codelineno-1-1></a><span class=c1>// Alice generates her master key pair</span>
<a id=__codelineno-1-2 name=__codelineno-1-2 href=#__codelineno-1-2></a><span class=kd>const</span><span class=w> </span><span class=nx>alice</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>PrivateKey</span><span class=p>.</span><span class=nx>fromRandom</span><span class=p>()</span>
<a id=__codelineno-1-3 name=__codelineno-1-3 href=#__codelineno-1-3></a><span class=kd>const</span><span class=w> </span><span class=nx>alicePub</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>alice</span><span class=p>.</span><span class=nx>toPublicKey</span><span class=p>()</span>
<a id=__codelineno-1-4 name=__codelineno-1-4 href=#__codelineno-1-4></a>
<a id=__codelineno-1-5 name=__codelineno-1-5 href=#__codelineno-1-5></a><span class=c1>// Bob generates his master key pair</span>
<a id=__codelineno-1-6 name=__codelineno-1-6 href=#__codelineno-1-6></a><span class=kd>const</span><span class=w> </span><span class=nx>bob</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>PrivateKey</span><span class=p>.</span><span class=nx>fromRandom</span><span class=p>()</span>
<a id=__codelineno-1-7 name=__codelineno-1-7 href=#__codelineno-1-7></a><span class=kd>const</span><span class=w> </span><span class=nx>bobPub</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>bob</span><span class=p>.</span><span class=nx>toPublicKey</span><span class=p>()</span>
<a id=__codelineno-1-8 name=__codelineno-1-8 href=#__codelineno-1-8></a>
<a id=__codelineno-1-9 name=__codelineno-1-9 href=#__codelineno-1-9></a><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;Alice master public key:&#39;</span><span class=p>,</span><span class=w> </span><span class=nx>alicePub</span><span class=p>.</span><span class=nx>toString</span><span class=p>())</span>
<a id=__codelineno-1-10 name=__codelineno-1-10 href=#__codelineno-1-10></a><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;Bob master public key:&#39;</span><span class=p>,</span><span class=w> </span><span class=nx>bobPub</span><span class=p>.</span><span class=nx>toString</span><span class=p>())</span>
</code></pre></div> <h3 id=step-2-invoice-number-agreement>Step 2: Invoice Number Agreement</h3> <div class=highlight><pre><span></span><code><a id=__codelineno-2-1 name=__codelineno-2-1 href=#__codelineno-2-1></a><span class=c1>// Both parties agree on an invoice number to use</span>
<a id=__codelineno-2-2 name=__codelineno-2-2 href=#__codelineno-2-2></a><span class=c1>// This could be a payment ID, message ID, or any unique identifier</span>
<a id=__codelineno-2-3 name=__codelineno-2-3 href=#__codelineno-2-3></a><span class=kd>const</span><span class=w> </span><span class=nx>invoiceNumber</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;2-simple signing protocol-1&#39;</span>
<a id=__codelineno-2-4 name=__codelineno-2-4 href=#__codelineno-2-4></a>
<a id=__codelineno-2-5 name=__codelineno-2-5 href=#__codelineno-2-5></a><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;Using invoice number:&#39;</span><span class=p>,</span><span class=w> </span><span class=nx>invoiceNumber</span><span class=p>)</span>
</code></pre></div> <h3 id=step-3-child-key-derivation>Step 3: Child Key Derivation</h3> <div class=highlight><pre><span></span><code><a id=__codelineno-3-1 name=__codelineno-3-1 href=#__codelineno-3-1></a><span class=c1>// Alice derives a child private key for signing</span>
<a id=__codelineno-3-2 name=__codelineno-3-2 href=#__codelineno-3-2></a><span class=kd>const</span><span class=w> </span><span class=nx>aliceSigningChild</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>alice</span><span class=p>.</span><span class=nx>deriveChild</span><span class=p>(</span><span class=nx>bobPub</span><span class=p>,</span><span class=w> </span><span class=nx>invoiceNumber</span><span class=p>)</span>
<a id=__codelineno-3-3 name=__codelineno-3-3 href=#__codelineno-3-3></a>
<a id=__codelineno-3-4 name=__codelineno-3-4 href=#__codelineno-3-4></a><span class=c1>// Bob derives Alice&#39;s corresponding public key</span>
<a id=__codelineno-3-5 name=__codelineno-3-5 href=#__codelineno-3-5></a><span class=kd>const</span><span class=w> </span><span class=nx>aliceSigningPub</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>alicePub</span><span class=p>.</span><span class=nx>deriveChild</span><span class=p>(</span><span class=nx>bob</span><span class=p>,</span><span class=w> </span><span class=nx>invoiceNumber</span><span class=p>)</span>
<a id=__codelineno-3-6 name=__codelineno-3-6 href=#__codelineno-3-6></a>
<a id=__codelineno-3-7 name=__codelineno-3-7 href=#__codelineno-3-7></a><span class=c1>// Verify the keys match</span>
<a id=__codelineno-3-8 name=__codelineno-3-8 href=#__codelineno-3-8></a><span class=kd>const</span><span class=w> </span><span class=nx>derivedPubFromPriv</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>aliceSigningChild</span><span class=p>.</span><span class=nx>toPublicKey</span><span class=p>()</span>
<a id=__codelineno-3-9 name=__codelineno-3-9 href=#__codelineno-3-9></a><span class=kd>const</span><span class=w> </span><span class=nx>keysMatch</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>derivedPubFromPriv</span><span class=p>.</span><span class=nx>toString</span><span class=p>()</span><span class=w> </span><span class=o>===</span><span class=w> </span><span class=nx>aliceSigningPub</span><span class=p>.</span><span class=nx>toString</span><span class=p>()</span>
<a id=__codelineno-3-10 name=__codelineno-3-10 href=#__codelineno-3-10></a><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;Keys match:&#39;</span><span class=p>,</span><span class=w> </span><span class=nx>keysMatch</span><span class=p>)</span>
<a id=__codelineno-3-11 name=__codelineno-3-11 href=#__codelineno-3-11></a><span class=c1>// true</span>
</code></pre></div> <h2 id=practical-example-message-signing>Practical Example: Message Signing</h2> <p>Let's implement a complete example where Alice signs a message for Bob using Type-42 derived keys:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-4-1 name=__codelineno-4-1 href=#__codelineno-4-1></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>PrivateKey</span><span class=p>,</span><span class=w> </span><span class=nx>Utils</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;@bsv/sdk&#39;</span>
<a id=__codelineno-4-2 name=__codelineno-4-2 href=#__codelineno-4-2></a>
<a id=__codelineno-4-3 name=__codelineno-4-3 href=#__codelineno-4-3></a><span class=k>async</span><span class=w> </span><span class=kd>function</span><span class=w> </span><span class=nx>demonstrateType42Signing</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-4-4 name=__codelineno-4-4 href=#__codelineno-4-4></a><span class=w>  </span><span class=c1>// Step 1: Generate master keys</span>
<a id=__codelineno-4-5 name=__codelineno-4-5 href=#__codelineno-4-5></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>alice</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>PrivateKey</span><span class=p>.</span><span class=nx>fromRandom</span><span class=p>()</span>
<a id=__codelineno-4-6 name=__codelineno-4-6 href=#__codelineno-4-6></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>alicePub</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>alice</span><span class=p>.</span><span class=nx>toPublicKey</span><span class=p>()</span>
<a id=__codelineno-4-7 name=__codelineno-4-7 href=#__codelineno-4-7></a>
<a id=__codelineno-4-8 name=__codelineno-4-8 href=#__codelineno-4-8></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>bob</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>PrivateKey</span><span class=p>.</span><span class=nx>fromRandom</span><span class=p>()</span>
<a id=__codelineno-4-9 name=__codelineno-4-9 href=#__codelineno-4-9></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>bobPub</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>bob</span><span class=p>.</span><span class=nx>toPublicKey</span><span class=p>()</span>
<a id=__codelineno-4-10 name=__codelineno-4-10 href=#__codelineno-4-10></a>
<a id=__codelineno-4-11 name=__codelineno-4-11 href=#__codelineno-4-11></a><span class=w>  </span><span class=c1>// Step 2: Agree on invoice number</span>
<a id=__codelineno-4-12 name=__codelineno-4-12 href=#__codelineno-4-12></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>invoiceNumber</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;2-secure-message-001&#39;</span>
<a id=__codelineno-4-13 name=__codelineno-4-13 href=#__codelineno-4-13></a>
<a id=__codelineno-4-14 name=__codelineno-4-14 href=#__codelineno-4-14></a><span class=w>  </span><span class=c1>// Step 3: Alice derives her signing key</span>
<a id=__codelineno-4-15 name=__codelineno-4-15 href=#__codelineno-4-15></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>aliceSigningChild</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>alice</span><span class=p>.</span><span class=nx>deriveChild</span><span class=p>(</span><span class=nx>bobPub</span><span class=p>,</span><span class=w> </span><span class=nx>invoiceNumber</span><span class=p>)</span>
<a id=__codelineno-4-16 name=__codelineno-4-16 href=#__codelineno-4-16></a>
<a id=__codelineno-4-17 name=__codelineno-4-17 href=#__codelineno-4-17></a><span class=w>  </span><span class=c1>// Step 4: Alice signs a message</span>
<a id=__codelineno-4-18 name=__codelineno-4-18 href=#__codelineno-4-18></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>message</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>Utils</span><span class=p>.</span><span class=nx>toArray</span><span class=p>(</span><span class=s1>&#39;Hello Bob, this is a secure message!&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;utf8&#39;</span><span class=p>)</span>
<a id=__codelineno-4-19 name=__codelineno-4-19 href=#__codelineno-4-19></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>signature</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>aliceSigningChild</span><span class=p>.</span><span class=nx>sign</span><span class=p>(</span><span class=nx>message</span><span class=p>)</span>
<a id=__codelineno-4-20 name=__codelineno-4-20 href=#__codelineno-4-20></a>
<a id=__codelineno-4-21 name=__codelineno-4-21 href=#__codelineno-4-21></a><span class=w>  </span><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;Message signed by Alice&#39;</span><span class=p>)</span>
<a id=__codelineno-4-22 name=__codelineno-4-22 href=#__codelineno-4-22></a><span class=w>  </span><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;Signature:&#39;</span><span class=p>,</span><span class=w> </span><span class=nx>signature</span><span class=p>.</span><span class=nx>toDER</span><span class=p>(</span><span class=s1>&#39;hex&#39;</span><span class=p>))</span>
<a id=__codelineno-4-23 name=__codelineno-4-23 href=#__codelineno-4-23></a>
<a id=__codelineno-4-24 name=__codelineno-4-24 href=#__codelineno-4-24></a><span class=w>  </span><span class=c1>// Step 5: Bob derives Alice&#39;s public key and verifies</span>
<a id=__codelineno-4-25 name=__codelineno-4-25 href=#__codelineno-4-25></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>aliceSigningPub</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>alicePub</span><span class=p>.</span><span class=nx>deriveChild</span><span class=p>(</span><span class=nx>bob</span><span class=p>,</span><span class=w> </span><span class=nx>invoiceNumber</span><span class=p>)</span>
<a id=__codelineno-4-26 name=__codelineno-4-26 href=#__codelineno-4-26></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>verified</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>aliceSigningPub</span><span class=p>.</span><span class=nx>verify</span><span class=p>(</span><span class=nx>message</span><span class=p>,</span><span class=w> </span><span class=nx>signature</span><span class=p>)</span>
<a id=__codelineno-4-27 name=__codelineno-4-27 href=#__codelineno-4-27></a>
<a id=__codelineno-4-28 name=__codelineno-4-28 href=#__codelineno-4-28></a><span class=w>  </span><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;Signature verified by Bob:&#39;</span><span class=p>,</span><span class=w> </span><span class=nx>verified</span><span class=p>)</span>
<a id=__codelineno-4-29 name=__codelineno-4-29 href=#__codelineno-4-29></a><span class=w>  </span><span class=c1>// true</span>
<a id=__codelineno-4-30 name=__codelineno-4-30 href=#__codelineno-4-30></a>
<a id=__codelineno-4-31 name=__codelineno-4-31 href=#__codelineno-4-31></a><span class=w>  </span><span class=k>return</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-4-32 name=__codelineno-4-32 href=#__codelineno-4-32></a><span class=w>    </span><span class=nx>alice</span><span class=p>,</span>
<a id=__codelineno-4-33 name=__codelineno-4-33 href=#__codelineno-4-33></a><span class=w>    </span><span class=nx>bob</span><span class=p>,</span>
<a id=__codelineno-4-34 name=__codelineno-4-34 href=#__codelineno-4-34></a><span class=w>    </span><span class=nx>aliceSigningChild</span><span class=p>,</span>
<a id=__codelineno-4-35 name=__codelineno-4-35 href=#__codelineno-4-35></a><span class=w>    </span><span class=nx>aliceSigningPub</span><span class=p>,</span>
<a id=__codelineno-4-36 name=__codelineno-4-36 href=#__codelineno-4-36></a><span class=w>    </span><span class=nx>message</span><span class=p>,</span>
<a id=__codelineno-4-37 name=__codelineno-4-37 href=#__codelineno-4-37></a><span class=w>    </span><span class=nx>signature</span><span class=p>,</span>
<a id=__codelineno-4-38 name=__codelineno-4-38 href=#__codelineno-4-38></a><span class=w>    </span><span class=nx>verified</span>
<a id=__codelineno-4-39 name=__codelineno-4-39 href=#__codelineno-4-39></a><span class=w>  </span><span class=p>}</span>
<a id=__codelineno-4-40 name=__codelineno-4-40 href=#__codelineno-4-40></a><span class=p>}</span>
<a id=__codelineno-4-41 name=__codelineno-4-41 href=#__codelineno-4-41></a>
<a id=__codelineno-4-42 name=__codelineno-4-42 href=#__codelineno-4-42></a><span class=c1>// Run the demonstration</span>
<a id=__codelineno-4-43 name=__codelineno-4-43 href=#__codelineno-4-43></a><span class=nx>demonstrateType42Signing</span><span class=p>()</span>
</code></pre></div> <h2 id=bidirectional-communication>Bidirectional Communication</h2> <p>Type-42 enables both parties to derive keys for each other. Here's how Bob can also sign messages for Alice:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-5-1 name=__codelineno-5-1 href=#__codelineno-5-1></a><span class=k>async</span><span class=w> </span><span class=kd>function</span><span class=w> </span><span class=nx>bidirectionalType42</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-5-2 name=__codelineno-5-2 href=#__codelineno-5-2></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>alice</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>PrivateKey</span><span class=p>.</span><span class=nx>fromRandom</span><span class=p>()</span>
<a id=__codelineno-5-3 name=__codelineno-5-3 href=#__codelineno-5-3></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>alicePub</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>alice</span><span class=p>.</span><span class=nx>toPublicKey</span><span class=p>()</span>
<a id=__codelineno-5-4 name=__codelineno-5-4 href=#__codelineno-5-4></a>
<a id=__codelineno-5-5 name=__codelineno-5-5 href=#__codelineno-5-5></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>bob</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>PrivateKey</span><span class=p>.</span><span class=nx>fromRandom</span><span class=p>()</span>
<a id=__codelineno-5-6 name=__codelineno-5-6 href=#__codelineno-5-6></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>bobPub</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>bob</span><span class=p>.</span><span class=nx>toPublicKey</span><span class=p>()</span>
<a id=__codelineno-5-7 name=__codelineno-5-7 href=#__codelineno-5-7></a>
<a id=__codelineno-5-8 name=__codelineno-5-8 href=#__codelineno-5-8></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>invoiceNumber</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;2-bidirectional-chat-001&#39;</span>
<a id=__codelineno-5-9 name=__codelineno-5-9 href=#__codelineno-5-9></a>
<a id=__codelineno-5-10 name=__codelineno-5-10 href=#__codelineno-5-10></a><span class=w>  </span><span class=c1>// Alice signs a message for Bob</span>
<a id=__codelineno-5-11 name=__codelineno-5-11 href=#__codelineno-5-11></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>aliceMessage</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>Utils</span><span class=p>.</span><span class=nx>toArray</span><span class=p>(</span><span class=s1>&#39;Hi Bob!&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;utf8&#39;</span><span class=p>)</span>
<a id=__codelineno-5-12 name=__codelineno-5-12 href=#__codelineno-5-12></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>aliceSigningKey</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>alice</span><span class=p>.</span><span class=nx>deriveChild</span><span class=p>(</span><span class=nx>bobPub</span><span class=p>,</span><span class=w> </span><span class=nx>invoiceNumber</span><span class=p>)</span>
<a id=__codelineno-5-13 name=__codelineno-5-13 href=#__codelineno-5-13></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>aliceSignature</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>aliceSigningKey</span><span class=p>.</span><span class=nx>sign</span><span class=p>(</span><span class=nx>aliceMessage</span><span class=p>)</span>
<a id=__codelineno-5-14 name=__codelineno-5-14 href=#__codelineno-5-14></a>
<a id=__codelineno-5-15 name=__codelineno-5-15 href=#__codelineno-5-15></a><span class=w>  </span><span class=c1>// Bob signs a reply for Alice</span>
<a id=__codelineno-5-16 name=__codelineno-5-16 href=#__codelineno-5-16></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>bobMessage</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>Utils</span><span class=p>.</span><span class=nx>toArray</span><span class=p>(</span><span class=s1>&#39;Hi Alice!&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;utf8&#39;</span><span class=p>)</span>
<a id=__codelineno-5-17 name=__codelineno-5-17 href=#__codelineno-5-17></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>bobSigningKey</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>bob</span><span class=p>.</span><span class=nx>deriveChild</span><span class=p>(</span><span class=nx>alicePub</span><span class=p>,</span><span class=w> </span><span class=nx>invoiceNumber</span><span class=p>)</span>
<a id=__codelineno-5-18 name=__codelineno-5-18 href=#__codelineno-5-18></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>bobSignature</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>bobSigningKey</span><span class=p>.</span><span class=nx>sign</span><span class=p>(</span><span class=nx>bobMessage</span><span class=p>)</span>
<a id=__codelineno-5-19 name=__codelineno-5-19 href=#__codelineno-5-19></a>
<a id=__codelineno-5-20 name=__codelineno-5-20 href=#__codelineno-5-20></a><span class=w>  </span><span class=c1>// Cross-verification</span>
<a id=__codelineno-5-21 name=__codelineno-5-21 href=#__codelineno-5-21></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>aliceVerifyKey</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>alicePub</span><span class=p>.</span><span class=nx>deriveChild</span><span class=p>(</span><span class=nx>bob</span><span class=p>,</span><span class=w> </span><span class=nx>invoiceNumber</span><span class=p>)</span>
<a id=__codelineno-5-22 name=__codelineno-5-22 href=#__codelineno-5-22></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>bobVerifyKey</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>bobPub</span><span class=p>.</span><span class=nx>deriveChild</span><span class=p>(</span><span class=nx>alice</span><span class=p>,</span><span class=w> </span><span class=nx>invoiceNumber</span><span class=p>)</span>
<a id=__codelineno-5-23 name=__codelineno-5-23 href=#__codelineno-5-23></a>
<a id=__codelineno-5-24 name=__codelineno-5-24 href=#__codelineno-5-24></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>aliceVerified</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>aliceVerifyKey</span><span class=p>.</span><span class=nx>verify</span><span class=p>(</span><span class=nx>aliceMessage</span><span class=p>,</span><span class=w> </span><span class=nx>aliceSignature</span><span class=p>)</span>
<a id=__codelineno-5-25 name=__codelineno-5-25 href=#__codelineno-5-25></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>bobVerified</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>bobVerifyKey</span><span class=p>.</span><span class=nx>verify</span><span class=p>(</span><span class=nx>bobMessage</span><span class=p>,</span><span class=w> </span><span class=nx>bobSignature</span><span class=p>)</span>
<a id=__codelineno-5-26 name=__codelineno-5-26 href=#__codelineno-5-26></a>
<a id=__codelineno-5-27 name=__codelineno-5-27 href=#__codelineno-5-27></a><span class=w>  </span><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;Alice message verified:&#39;</span><span class=p>,</span><span class=w> </span><span class=nx>aliceVerified</span><span class=p>)</span>
<a id=__codelineno-5-28 name=__codelineno-5-28 href=#__codelineno-5-28></a><span class=w>  </span><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;Bob message verified:&#39;</span><span class=p>,</span><span class=w> </span><span class=nx>bobVerified</span><span class=p>)</span>
<a id=__codelineno-5-29 name=__codelineno-5-29 href=#__codelineno-5-29></a>
<a id=__codelineno-5-30 name=__codelineno-5-30 href=#__codelineno-5-30></a><span class=w>  </span><span class=k>return</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>aliceVerified</span><span class=p>,</span><span class=w> </span><span class=nx>bobVerified</span><span class=w> </span><span class=p>}</span>
<a id=__codelineno-5-31 name=__codelineno-5-31 href=#__codelineno-5-31></a><span class=p>}</span>
</code></pre></div> <h2 id=the-anyone-key-concept>The "Anyone Key" Concept</h2> <p>The SDK supports a special "anyone" key concept for scenarios where one party wants to create publicly verifiable signatures. The "anyone" key is simply the private key with value 1:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-6-1 name=__codelineno-6-1 href=#__codelineno-6-1></a><span class=c1>// The &quot;anyone&quot; private key</span>
<a id=__codelineno-6-2 name=__codelineno-6-2 href=#__codelineno-6-2></a><span class=kd>const</span><span class=w> </span><span class=nx>anyonePrivateKey</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=ow>new</span><span class=w> </span><span class=nx>PrivateKey</span><span class=p>(</span><span class=mf>1</span><span class=p>)</span>
<a id=__codelineno-6-3 name=__codelineno-6-3 href=#__codelineno-6-3></a><span class=kd>const</span><span class=w> </span><span class=nx>anyonePublicKey</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>anyonePrivateKey</span><span class=p>.</span><span class=nx>toPublicKey</span><span class=p>()</span>
<a id=__codelineno-6-4 name=__codelineno-6-4 href=#__codelineno-6-4></a>
<a id=__codelineno-6-5 name=__codelineno-6-5 href=#__codelineno-6-5></a><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;Anyone public key:&#39;</span><span class=p>,</span><span class=w> </span><span class=nx>anyonePublicKey</span><span class=p>.</span><span class=nx>toString</span><span class=p>())</span>
<a id=__codelineno-6-6 name=__codelineno-6-6 href=#__codelineno-6-6></a>
<a id=__codelineno-6-7 name=__codelineno-6-7 href=#__codelineno-6-7></a><span class=c1>// Using &quot;anyone&quot; key for public verification</span>
<a id=__codelineno-6-8 name=__codelineno-6-8 href=#__codelineno-6-8></a><span class=kd>function</span><span class=w> </span><span class=nx>createPubliclyVerifiableSignature</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-6-9 name=__codelineno-6-9 href=#__codelineno-6-9></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>signer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>PrivateKey</span><span class=p>.</span><span class=nx>fromRandom</span><span class=p>()</span>
<a id=__codelineno-6-10 name=__codelineno-6-10 href=#__codelineno-6-10></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>invoiceNumber</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;2-public-announcement-001&#39;</span>
<a id=__codelineno-6-11 name=__codelineno-6-11 href=#__codelineno-6-11></a>
<a id=__codelineno-6-12 name=__codelineno-6-12 href=#__codelineno-6-12></a><span class=w>  </span><span class=c1>// Derive key using &quot;anyone&quot; as counterparty</span>
<a id=__codelineno-6-13 name=__codelineno-6-13 href=#__codelineno-6-13></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>signingKey</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>signer</span><span class=p>.</span><span class=nx>deriveChild</span><span class=p>(</span><span class=nx>anyonePublicKey</span><span class=p>,</span><span class=w> </span><span class=nx>invoiceNumber</span><span class=p>)</span>
<a id=__codelineno-6-14 name=__codelineno-6-14 href=#__codelineno-6-14></a>
<a id=__codelineno-6-15 name=__codelineno-6-15 href=#__codelineno-6-15></a><span class=w>  </span><span class=c1>// Sign message</span>
<a id=__codelineno-6-16 name=__codelineno-6-16 href=#__codelineno-6-16></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>message</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>Utils</span><span class=p>.</span><span class=nx>toArray</span><span class=p>(</span><span class=s1>&#39;This is a public announcement&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;utf8&#39;</span><span class=p>)</span>
<a id=__codelineno-6-17 name=__codelineno-6-17 href=#__codelineno-6-17></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>signature</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>signingKey</span><span class=p>.</span><span class=nx>sign</span><span class=p>(</span><span class=nx>message</span><span class=p>)</span>
<a id=__codelineno-6-18 name=__codelineno-6-18 href=#__codelineno-6-18></a>
<a id=__codelineno-6-19 name=__codelineno-6-19 href=#__codelineno-6-19></a><span class=w>  </span><span class=c1>// Anyone can verify using the signer&#39;s public key</span>
<a id=__codelineno-6-20 name=__codelineno-6-20 href=#__codelineno-6-20></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>signerPub</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>signer</span><span class=p>.</span><span class=nx>toPublicKey</span><span class=p>()</span>
<a id=__codelineno-6-21 name=__codelineno-6-21 href=#__codelineno-6-21></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>verifyKey</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>signerPub</span><span class=p>.</span><span class=nx>deriveChild</span><span class=p>(</span><span class=nx>anyonePrivateKey</span><span class=p>,</span><span class=w> </span><span class=nx>invoiceNumber</span><span class=p>)</span>
<a id=__codelineno-6-22 name=__codelineno-6-22 href=#__codelineno-6-22></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>verified</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>verifyKey</span><span class=p>.</span><span class=nx>verify</span><span class=p>(</span><span class=nx>message</span><span class=p>,</span><span class=w> </span><span class=nx>signature</span><span class=p>)</span>
<a id=__codelineno-6-23 name=__codelineno-6-23 href=#__codelineno-6-23></a>
<a id=__codelineno-6-24 name=__codelineno-6-24 href=#__codelineno-6-24></a><span class=w>  </span><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;Public signature verified:&#39;</span><span class=p>,</span><span class=w> </span><span class=nx>verified</span><span class=p>)</span>
<a id=__codelineno-6-25 name=__codelineno-6-25 href=#__codelineno-6-25></a>
<a id=__codelineno-6-26 name=__codelineno-6-26 href=#__codelineno-6-26></a><span class=w>  </span><span class=k>return</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-6-27 name=__codelineno-6-27 href=#__codelineno-6-27></a><span class=w>    </span><span class=nx>signerPublicKey</span><span class=o>:</span><span class=w> </span><span class=kt>signerPub.toString</span><span class=p>(),</span>
<a id=__codelineno-6-28 name=__codelineno-6-28 href=#__codelineno-6-28></a><span class=w>    </span><span class=nx>signature</span><span class=o>:</span><span class=w> </span><span class=kt>signature.toDER</span><span class=p>(</span><span class=s1>&#39;hex&#39;</span><span class=p>),</span>
<a id=__codelineno-6-29 name=__codelineno-6-29 href=#__codelineno-6-29></a><span class=w>    </span><span class=nx>verified</span>
<a id=__codelineno-6-30 name=__codelineno-6-30 href=#__codelineno-6-30></a><span class=w>  </span><span class=p>}</span>
<a id=__codelineno-6-31 name=__codelineno-6-31 href=#__codelineno-6-31></a><span class=p>}</span>
<a id=__codelineno-6-32 name=__codelineno-6-32 href=#__codelineno-6-32></a>
<a id=__codelineno-6-33 name=__codelineno-6-33 href=#__codelineno-6-33></a><span class=nx>createPubliclyVerifiableSignature</span><span class=p>()</span>
</code></pre></div> <h2 id=advanced-type-42-applications>Advanced Type-42 Applications</h2> <h3 id=multi-purpose-key-derivation>Multi-Purpose Key Derivation</h3> <p>Use different invoice numbers for different purposes:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-7-1 name=__codelineno-7-1 href=#__codelineno-7-1></a><span class=kd>function</span><span class=w> </span><span class=nx>multiPurposeKeyDerivation</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-7-2 name=__codelineno-7-2 href=#__codelineno-7-2></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>alice</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>PrivateKey</span><span class=p>.</span><span class=nx>fromRandom</span><span class=p>()</span>
<a id=__codelineno-7-3 name=__codelineno-7-3 href=#__codelineno-7-3></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>bob</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>PrivateKey</span><span class=p>.</span><span class=nx>fromRandom</span><span class=p>()</span>
<a id=__codelineno-7-4 name=__codelineno-7-4 href=#__codelineno-7-4></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>bobPub</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>bob</span><span class=p>.</span><span class=nx>toPublicKey</span><span class=p>()</span>
<a id=__codelineno-7-5 name=__codelineno-7-5 href=#__codelineno-7-5></a>
<a id=__codelineno-7-6 name=__codelineno-7-6 href=#__codelineno-7-6></a><span class=w>  </span><span class=c1>// Different keys for different purposes</span>
<a id=__codelineno-7-7 name=__codelineno-7-7 href=#__codelineno-7-7></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>signingKey</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>alice</span><span class=p>.</span><span class=nx>deriveChild</span><span class=p>(</span><span class=nx>bobPub</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;2-signing-001&#39;</span><span class=p>)</span>
<a id=__codelineno-7-8 name=__codelineno-7-8 href=#__codelineno-7-8></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>encryptionKey</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>alice</span><span class=p>.</span><span class=nx>deriveChild</span><span class=p>(</span><span class=nx>bobPub</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;2-encryption-001&#39;</span><span class=p>)</span>
<a id=__codelineno-7-9 name=__codelineno-7-9 href=#__codelineno-7-9></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>authKey</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>alice</span><span class=p>.</span><span class=nx>deriveChild</span><span class=p>(</span><span class=nx>bobPub</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;2-auth-001&#39;</span><span class=p>)</span>
<a id=__codelineno-7-10 name=__codelineno-7-10 href=#__codelineno-7-10></a>
<a id=__codelineno-7-11 name=__codelineno-7-11 href=#__codelineno-7-11></a><span class=w>  </span><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;Signing key:&#39;</span><span class=p>,</span><span class=w> </span><span class=nx>signingKey</span><span class=p>.</span><span class=nx>toHex</span><span class=p>().</span><span class=nx>substring</span><span class=p>(</span><span class=mf>0</span><span class=p>,</span><span class=w> </span><span class=mf>16</span><span class=p>)</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s1>&#39;...&#39;</span><span class=p>)</span>
<a id=__codelineno-7-12 name=__codelineno-7-12 href=#__codelineno-7-12></a><span class=w>  </span><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;Encryption key:&#39;</span><span class=p>,</span><span class=w> </span><span class=nx>encryptionKey</span><span class=p>.</span><span class=nx>toHex</span><span class=p>().</span><span class=nx>substring</span><span class=p>(</span><span class=mf>0</span><span class=p>,</span><span class=w> </span><span class=mf>16</span><span class=p>)</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s1>&#39;...&#39;</span><span class=p>)</span>
<a id=__codelineno-7-13 name=__codelineno-7-13 href=#__codelineno-7-13></a><span class=w>  </span><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;Auth key:&#39;</span><span class=p>,</span><span class=w> </span><span class=nx>authKey</span><span class=p>.</span><span class=nx>toHex</span><span class=p>().</span><span class=nx>substring</span><span class=p>(</span><span class=mf>0</span><span class=p>,</span><span class=w> </span><span class=mf>16</span><span class=p>)</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s1>&#39;...&#39;</span><span class=p>)</span>
<a id=__codelineno-7-14 name=__codelineno-7-14 href=#__codelineno-7-14></a>
<a id=__codelineno-7-15 name=__codelineno-7-15 href=#__codelineno-7-15></a><span class=w>  </span><span class=c1>// Each key is unique and serves a different purpose</span>
<a id=__codelineno-7-16 name=__codelineno-7-16 href=#__codelineno-7-16></a><span class=w>  </span><span class=k>return</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>signingKey</span><span class=p>,</span><span class=w> </span><span class=nx>encryptionKey</span><span class=p>,</span><span class=w> </span><span class=nx>authKey</span><span class=w> </span><span class=p>}</span>
<a id=__codelineno-7-17 name=__codelineno-7-17 href=#__codelineno-7-17></a><span class=p>}</span>
</code></pre></div> <h3 id=session-based-key-derivation>Session-Based Key Derivation</h3> <p>Create time-based or session-based keys:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-8-1 name=__codelineno-8-1 href=#__codelineno-8-1></a><span class=kd>function</span><span class=w> </span><span class=nx>sessionBasedKeys</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-8-2 name=__codelineno-8-2 href=#__codelineno-8-2></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>alice</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>PrivateKey</span><span class=p>.</span><span class=nx>fromRandom</span><span class=p>()</span>
<a id=__codelineno-8-3 name=__codelineno-8-3 href=#__codelineno-8-3></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>bob</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>PrivateKey</span><span class=p>.</span><span class=nx>fromRandom</span><span class=p>()</span>
<a id=__codelineno-8-4 name=__codelineno-8-4 href=#__codelineno-8-4></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>bobPub</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>bob</span><span class=p>.</span><span class=nx>toPublicKey</span><span class=p>()</span>
<a id=__codelineno-8-5 name=__codelineno-8-5 href=#__codelineno-8-5></a>
<a id=__codelineno-8-6 name=__codelineno-8-6 href=#__codelineno-8-6></a><span class=w>  </span><span class=c1>// Create session-specific keys</span>
<a id=__codelineno-8-7 name=__codelineno-8-7 href=#__codelineno-8-7></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>sessionId</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>Date</span><span class=p>.</span><span class=nx>now</span><span class=p>().</span><span class=nx>toString</span><span class=p>()</span>
<a id=__codelineno-8-8 name=__codelineno-8-8 href=#__codelineno-8-8></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>sessionInvoice</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=sb>`2-session-</span><span class=si>${</span><span class=nx>sessionId</span><span class=si>}</span><span class=sb>`</span>
<a id=__codelineno-8-9 name=__codelineno-8-9 href=#__codelineno-8-9></a>
<a id=__codelineno-8-10 name=__codelineno-8-10 href=#__codelineno-8-10></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>sessionKey</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>alice</span><span class=p>.</span><span class=nx>deriveChild</span><span class=p>(</span><span class=nx>bobPub</span><span class=p>,</span><span class=w> </span><span class=nx>sessionInvoice</span><span class=p>)</span>
<a id=__codelineno-8-11 name=__codelineno-8-11 href=#__codelineno-8-11></a>
<a id=__codelineno-8-12 name=__codelineno-8-12 href=#__codelineno-8-12></a><span class=w>  </span><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;Session ID:&#39;</span><span class=p>,</span><span class=w> </span><span class=nx>sessionId</span><span class=p>)</span>
<a id=__codelineno-8-13 name=__codelineno-8-13 href=#__codelineno-8-13></a><span class=w>  </span><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;Session key created:&#39;</span><span class=p>,</span><span class=w> </span><span class=nx>sessionKey</span><span class=p>.</span><span class=nx>toHex</span><span class=p>().</span><span class=nx>substring</span><span class=p>(</span><span class=mf>0</span><span class=p>,</span><span class=w> </span><span class=mf>16</span><span class=p>)</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s1>&#39;...&#39;</span><span class=p>)</span>
<a id=__codelineno-8-14 name=__codelineno-8-14 href=#__codelineno-8-14></a>
<a id=__codelineno-8-15 name=__codelineno-8-15 href=#__codelineno-8-15></a><span class=w>  </span><span class=k>return</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>sessionId</span><span class=p>,</span><span class=w> </span><span class=nx>sessionKey</span><span class=w> </span><span class=p>}</span>
<a id=__codelineno-8-16 name=__codelineno-8-16 href=#__codelineno-8-16></a><span class=p>}</span>
</code></pre></div> <h2 id=integration-with-transactions>Integration with Transactions</h2> <p>Type-42 derived keys can be used in Bitcoin transactions:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-9-1 name=__codelineno-9-1 href=#__codelineno-9-1></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>Transaction</span><span class=p>,</span><span class=w> </span><span class=nx>P2PKH</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;@bsv/sdk&#39;</span>
<a id=__codelineno-9-2 name=__codelineno-9-2 href=#__codelineno-9-2></a>
<a id=__codelineno-9-3 name=__codelineno-9-3 href=#__codelineno-9-3></a><span class=k>async</span><span class=w> </span><span class=kd>function</span><span class=w> </span><span class=nx>type42Transaction</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-9-4 name=__codelineno-9-4 href=#__codelineno-9-4></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>alice</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>PrivateKey</span><span class=p>.</span><span class=nx>fromRandom</span><span class=p>()</span>
<a id=__codelineno-9-5 name=__codelineno-9-5 href=#__codelineno-9-5></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>bob</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>PrivateKey</span><span class=p>.</span><span class=nx>fromRandom</span><span class=p>()</span>
<a id=__codelineno-9-6 name=__codelineno-9-6 href=#__codelineno-9-6></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>bobPub</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>bob</span><span class=p>.</span><span class=nx>toPublicKey</span><span class=p>()</span>
<a id=__codelineno-9-7 name=__codelineno-9-7 href=#__codelineno-9-7></a>
<a id=__codelineno-9-8 name=__codelineno-9-8 href=#__codelineno-9-8></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>invoiceNumber</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;2-payment-001&#39;</span>
<a id=__codelineno-9-9 name=__codelineno-9-9 href=#__codelineno-9-9></a>
<a id=__codelineno-9-10 name=__codelineno-9-10 href=#__codelineno-9-10></a><span class=w>  </span><span class=c1>// Alice derives a key for this specific payment</span>
<a id=__codelineno-9-11 name=__codelineno-9-11 href=#__codelineno-9-11></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>paymentKey</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>alice</span><span class=p>.</span><span class=nx>deriveChild</span><span class=p>(</span><span class=nx>bobPub</span><span class=p>,</span><span class=w> </span><span class=nx>invoiceNumber</span><span class=p>)</span>
<a id=__codelineno-9-12 name=__codelineno-9-12 href=#__codelineno-9-12></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>paymentAddress</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>paymentKey</span><span class=p>.</span><span class=nx>toAddress</span><span class=p>()</span>
<a id=__codelineno-9-13 name=__codelineno-9-13 href=#__codelineno-9-13></a>
<a id=__codelineno-9-14 name=__codelineno-9-14 href=#__codelineno-9-14></a><span class=w>  </span><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;Payment address:&#39;</span><span class=p>,</span><span class=w> </span><span class=nx>paymentAddress</span><span class=p>)</span>
<a id=__codelineno-9-15 name=__codelineno-9-15 href=#__codelineno-9-15></a>
<a id=__codelineno-9-16 name=__codelineno-9-16 href=#__codelineno-9-16></a><span class=w>  </span><span class=c1>// Bob can derive the same public key to verify ownership</span>
<a id=__codelineno-9-17 name=__codelineno-9-17 href=#__codelineno-9-17></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>alicePub</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>alice</span><span class=p>.</span><span class=nx>toPublicKey</span><span class=p>()</span>
<a id=__codelineno-9-18 name=__codelineno-9-18 href=#__codelineno-9-18></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>verifyKey</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>alicePub</span><span class=p>.</span><span class=nx>deriveChild</span><span class=p>(</span><span class=nx>bob</span><span class=p>,</span><span class=w> </span><span class=nx>invoiceNumber</span><span class=p>)</span>
<a id=__codelineno-9-19 name=__codelineno-9-19 href=#__codelineno-9-19></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>verifyAddress</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>verifyKey</span><span class=p>.</span><span class=nx>toAddress</span><span class=p>()</span>
<a id=__codelineno-9-20 name=__codelineno-9-20 href=#__codelineno-9-20></a>
<a id=__codelineno-9-21 name=__codelineno-9-21 href=#__codelineno-9-21></a><span class=w>  </span><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;Addresses match:&#39;</span><span class=p>,</span><span class=w> </span><span class=nx>paymentAddress</span><span class=w> </span><span class=o>===</span><span class=w> </span><span class=nx>verifyAddress</span><span class=p>)</span>
<a id=__codelineno-9-22 name=__codelineno-9-22 href=#__codelineno-9-22></a>
<a id=__codelineno-9-23 name=__codelineno-9-23 href=#__codelineno-9-23></a><span class=w>  </span><span class=k>return</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>paymentKey</span><span class=p>,</span><span class=w> </span><span class=nx>paymentAddress</span><span class=p>,</span><span class=w> </span><span class=nx>verifyAddress</span><span class=w> </span><span class=p>}</span>
<a id=__codelineno-9-24 name=__codelineno-9-24 href=#__codelineno-9-24></a><span class=p>}</span>
</code></pre></div> <h2 id=error-handling-and-validation>Error Handling and Validation</h2> <p>Implement robust error handling for Type-42 operations:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-10-1 name=__codelineno-10-1 href=#__codelineno-10-1></a><span class=kd>function</span><span class=w> </span><span class=nx>safeType42Derivation</span><span class=p>(</span>
<a id=__codelineno-10-2 name=__codelineno-10-2 href=#__codelineno-10-2></a><span class=w>  </span><span class=nx>privateKey</span><span class=o>:</span><span class=w> </span><span class=kt>PrivateKey</span><span class=p>,</span>
<a id=__codelineno-10-3 name=__codelineno-10-3 href=#__codelineno-10-3></a><span class=w>  </span><span class=nx>counterpartyPublicKey</span><span class=o>:</span><span class=w> </span><span class=kt>PublicKey</span><span class=p>,</span>
<a id=__codelineno-10-4 name=__codelineno-10-4 href=#__codelineno-10-4></a><span class=w>  </span><span class=nx>invoiceNumber</span><span class=o>:</span><span class=w> </span><span class=kt>string</span>
<a id=__codelineno-10-5 name=__codelineno-10-5 href=#__codelineno-10-5></a><span class=p>)</span><span class=o>:</span><span class=w> </span><span class=nx>PrivateKey</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-10-6 name=__codelineno-10-6 href=#__codelineno-10-6></a><span class=w>  </span><span class=k>try</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-10-7 name=__codelineno-10-7 href=#__codelineno-10-7></a><span class=w>    </span><span class=c1>// Validate inputs</span>
<a id=__codelineno-10-8 name=__codelineno-10-8 href=#__codelineno-10-8></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=nx>privateKey</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=o>!</span><span class=nx>counterpartyPublicKey</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=o>!</span><span class=nx>invoiceNumber</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-10-9 name=__codelineno-10-9 href=#__codelineno-10-9></a><span class=w>      </span><span class=k>throw</span><span class=w> </span><span class=ow>new</span><span class=w> </span><span class=ne>Error</span><span class=p>(</span><span class=s1>&#39;Missing required parameters&#39;</span><span class=p>)</span>
<a id=__codelineno-10-10 name=__codelineno-10-10 href=#__codelineno-10-10></a><span class=w>    </span><span class=p>}</span>
<a id=__codelineno-10-11 name=__codelineno-10-11 href=#__codelineno-10-11></a>
<a id=__codelineno-10-12 name=__codelineno-10-12 href=#__codelineno-10-12></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nx>invoiceNumber</span><span class=p>.</span><span class=nx>length</span><span class=w> </span><span class=o>===</span><span class=w> </span><span class=mf>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-10-13 name=__codelineno-10-13 href=#__codelineno-10-13></a><span class=w>      </span><span class=k>throw</span><span class=w> </span><span class=ow>new</span><span class=w> </span><span class=ne>Error</span><span class=p>(</span><span class=s1>&#39;Invoice number cannot be empty&#39;</span><span class=p>)</span>
<a id=__codelineno-10-14 name=__codelineno-10-14 href=#__codelineno-10-14></a><span class=w>    </span><span class=p>}</span>
<a id=__codelineno-10-15 name=__codelineno-10-15 href=#__codelineno-10-15></a>
<a id=__codelineno-10-16 name=__codelineno-10-16 href=#__codelineno-10-16></a><span class=w>    </span><span class=c1>// Perform derivation</span>
<a id=__codelineno-10-17 name=__codelineno-10-17 href=#__codelineno-10-17></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>derivedKey</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>privateKey</span><span class=p>.</span><span class=nx>deriveChild</span><span class=p>(</span><span class=nx>counterpartyPublicKey</span><span class=p>,</span><span class=w> </span><span class=nx>invoiceNumber</span><span class=p>)</span>
<a id=__codelineno-10-18 name=__codelineno-10-18 href=#__codelineno-10-18></a>
<a id=__codelineno-10-19 name=__codelineno-10-19 href=#__codelineno-10-19></a><span class=w>    </span><span class=c1>// Validate result</span>
<a id=__codelineno-10-20 name=__codelineno-10-20 href=#__codelineno-10-20></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=nx>derivedKey</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-10-21 name=__codelineno-10-21 href=#__codelineno-10-21></a><span class=w>      </span><span class=k>throw</span><span class=w> </span><span class=ow>new</span><span class=w> </span><span class=ne>Error</span><span class=p>(</span><span class=s1>&#39;Key derivation failed&#39;</span><span class=p>)</span>
<a id=__codelineno-10-22 name=__codelineno-10-22 href=#__codelineno-10-22></a><span class=w>    </span><span class=p>}</span>
<a id=__codelineno-10-23 name=__codelineno-10-23 href=#__codelineno-10-23></a>
<a id=__codelineno-10-24 name=__codelineno-10-24 href=#__codelineno-10-24></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nx>derivedKey</span>
<a id=__codelineno-10-25 name=__codelineno-10-25 href=#__codelineno-10-25></a><span class=w>  </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=nx>error</span><span class=o>:</span><span class=w> </span><span class=kt>any</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-10-26 name=__codelineno-10-26 href=#__codelineno-10-26></a><span class=w>    </span><span class=nx>console</span><span class=p>.</span><span class=nx>error</span><span class=p>(</span><span class=s1>&#39;Type-42 derivation error:&#39;</span><span class=p>,</span><span class=w> </span><span class=nx>error</span><span class=p>.</span><span class=nx>message</span><span class=p>)</span>
<a id=__codelineno-10-27 name=__codelineno-10-27 href=#__codelineno-10-27></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=kc>null</span>
<a id=__codelineno-10-28 name=__codelineno-10-28 href=#__codelineno-10-28></a><span class=w>  </span><span class=p>}</span>
<a id=__codelineno-10-29 name=__codelineno-10-29 href=#__codelineno-10-29></a><span class=p>}</span>
<a id=__codelineno-10-30 name=__codelineno-10-30 href=#__codelineno-10-30></a>
<a id=__codelineno-10-31 name=__codelineno-10-31 href=#__codelineno-10-31></a><span class=c1>// Usage example</span>
<a id=__codelineno-10-32 name=__codelineno-10-32 href=#__codelineno-10-32></a><span class=kd>const</span><span class=w> </span><span class=nx>alice</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>PrivateKey</span><span class=p>.</span><span class=nx>fromRandom</span><span class=p>()</span>
<a id=__codelineno-10-33 name=__codelineno-10-33 href=#__codelineno-10-33></a><span class=kd>const</span><span class=w> </span><span class=nx>bob</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>PrivateKey</span><span class=p>.</span><span class=nx>fromRandom</span><span class=p>()</span>
<a id=__codelineno-10-34 name=__codelineno-10-34 href=#__codelineno-10-34></a><span class=kd>const</span><span class=w> </span><span class=nx>bobPub</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>bob</span><span class=p>.</span><span class=nx>toPublicKey</span><span class=p>()</span>
<a id=__codelineno-10-35 name=__codelineno-10-35 href=#__codelineno-10-35></a>
<a id=__codelineno-10-36 name=__codelineno-10-36 href=#__codelineno-10-36></a><span class=kd>const</span><span class=w> </span><span class=nx>derivedKey</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>safeType42Derivation</span><span class=p>(</span><span class=nx>alice</span><span class=p>,</span><span class=w> </span><span class=nx>bobPub</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;2-safe-derivation-001&#39;</span><span class=p>)</span>
<a id=__codelineno-10-37 name=__codelineno-10-37 href=#__codelineno-10-37></a><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nx>derivedKey</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-10-38 name=__codelineno-10-38 href=#__codelineno-10-38></a><span class=w>  </span><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;Derivation successful&#39;</span><span class=p>)</span>
<a id=__codelineno-10-39 name=__codelineno-10-39 href=#__codelineno-10-39></a><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-10-40 name=__codelineno-10-40 href=#__codelineno-10-40></a><span class=w>  </span><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;Derivation failed&#39;</span><span class=p>)</span>
<a id=__codelineno-10-41 name=__codelineno-10-41 href=#__codelineno-10-41></a><span class=p>}</span>
</code></pre></div> <h2 id=performance-considerations>Performance Considerations</h2> <h3 id=caching-derived-keys>Caching Derived Keys</h3> <p>For applications that frequently use the same invoice numbers:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-11-1 name=__codelineno-11-1 href=#__codelineno-11-1></a><span class=kd>class</span><span class=w> </span><span class=nx>Type42KeyCache</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-11-2 name=__codelineno-11-2 href=#__codelineno-11-2></a><span class=w>  </span><span class=k>private</span><span class=w> </span><span class=nx>cache</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=ow>new</span><span class=w> </span><span class=nb>Map</span><span class=o>&lt;</span><span class=kt>string</span><span class=p>,</span><span class=w> </span><span class=nx>PrivateKey</span><span class=o>&gt;</span><span class=p>()</span>
<a id=__codelineno-11-3 name=__codelineno-11-3 href=#__codelineno-11-3></a>
<a id=__codelineno-11-4 name=__codelineno-11-4 href=#__codelineno-11-4></a><span class=w>  </span><span class=kr>constructor</span><span class=p>(</span><span class=k>private</span><span class=w> </span><span class=nx>masterKey</span><span class=o>:</span><span class=w> </span><span class=kt>PrivateKey</span><span class=p>)</span><span class=w> </span><span class=p>{}</span>
<a id=__codelineno-11-5 name=__codelineno-11-5 href=#__codelineno-11-5></a>
<a id=__codelineno-11-6 name=__codelineno-11-6 href=#__codelineno-11-6></a><span class=w>  </span><span class=nx>deriveKey</span><span class=p>(</span><span class=nx>counterpartyPub</span><span class=o>:</span><span class=w> </span><span class=kt>PublicKey</span><span class=p>,</span><span class=w> </span><span class=nx>invoiceNumber</span><span class=o>:</span><span class=w> </span><span class=kt>string</span><span class=p>)</span><span class=o>:</span><span class=w> </span><span class=nx>PrivateKey</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-11-7 name=__codelineno-11-7 href=#__codelineno-11-7></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>cacheKey</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=sb>`</span><span class=si>${</span><span class=nx>counterpartyPub</span><span class=p>.</span><span class=nx>toString</span><span class=p>()</span><span class=si>}</span><span class=sb>-</span><span class=si>${</span><span class=nx>invoiceNumber</span><span class=si>}</span><span class=sb>`</span>
<a id=__codelineno-11-8 name=__codelineno-11-8 href=#__codelineno-11-8></a>
<a id=__codelineno-11-9 name=__codelineno-11-9 href=#__codelineno-11-9></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>cache</span><span class=p>.</span><span class=nx>has</span><span class=p>(</span><span class=nx>cacheKey</span><span class=p>))</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-11-10 name=__codelineno-11-10 href=#__codelineno-11-10></a><span class=w>      </span><span class=k>return</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=nx>cache</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=nx>cacheKey</span><span class=p>)</span><span class=o>!</span>
<a id=__codelineno-11-11 name=__codelineno-11-11 href=#__codelineno-11-11></a><span class=w>    </span><span class=p>}</span>
<a id=__codelineno-11-12 name=__codelineno-11-12 href=#__codelineno-11-12></a>
<a id=__codelineno-11-13 name=__codelineno-11-13 href=#__codelineno-11-13></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>derivedKey</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=nx>masterKey</span><span class=p>.</span><span class=nx>deriveChild</span><span class=p>(</span><span class=nx>counterpartyPub</span><span class=p>,</span><span class=w> </span><span class=nx>invoiceNumber</span><span class=p>)</span>
<a id=__codelineno-11-14 name=__codelineno-11-14 href=#__codelineno-11-14></a><span class=w>    </span><span class=k>this</span><span class=p>.</span><span class=nx>cache</span><span class=p>.</span><span class=nx>set</span><span class=p>(</span><span class=nx>cacheKey</span><span class=p>,</span><span class=w> </span><span class=nx>derivedKey</span><span class=p>)</span>
<a id=__codelineno-11-15 name=__codelineno-11-15 href=#__codelineno-11-15></a>
<a id=__codelineno-11-16 name=__codelineno-11-16 href=#__codelineno-11-16></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nx>derivedKey</span>
<a id=__codelineno-11-17 name=__codelineno-11-17 href=#__codelineno-11-17></a><span class=w>  </span><span class=p>}</span>
<a id=__codelineno-11-18 name=__codelineno-11-18 href=#__codelineno-11-18></a>
<a id=__codelineno-11-19 name=__codelineno-11-19 href=#__codelineno-11-19></a><span class=w>  </span><span class=nx>clearCache</span><span class=p>()</span><span class=o>:</span><span class=w> </span><span class=ow>void</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-11-20 name=__codelineno-11-20 href=#__codelineno-11-20></a><span class=w>    </span><span class=k>this</span><span class=p>.</span><span class=nx>cache</span><span class=p>.</span><span class=nx>clear</span><span class=p>()</span>
<a id=__codelineno-11-21 name=__codelineno-11-21 href=#__codelineno-11-21></a><span class=w>  </span><span class=p>}</span>
<a id=__codelineno-11-22 name=__codelineno-11-22 href=#__codelineno-11-22></a>
<a id=__codelineno-11-23 name=__codelineno-11-23 href=#__codelineno-11-23></a><span class=w>  </span><span class=nx>getCacheSize</span><span class=p>()</span><span class=o>:</span><span class=w> </span><span class=kt>number</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-11-24 name=__codelineno-11-24 href=#__codelineno-11-24></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=nx>cache</span><span class=p>.</span><span class=nx>size</span>
<a id=__codelineno-11-25 name=__codelineno-11-25 href=#__codelineno-11-25></a><span class=w>  </span><span class=p>}</span>
<a id=__codelineno-11-26 name=__codelineno-11-26 href=#__codelineno-11-26></a><span class=p>}</span>
<a id=__codelineno-11-27 name=__codelineno-11-27 href=#__codelineno-11-27></a>
<a id=__codelineno-11-28 name=__codelineno-11-28 href=#__codelineno-11-28></a><span class=c1>// Usage</span>
<a id=__codelineno-11-29 name=__codelineno-11-29 href=#__codelineno-11-29></a><span class=kd>const</span><span class=w> </span><span class=nx>alice</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>PrivateKey</span><span class=p>.</span><span class=nx>fromRandom</span><span class=p>()</span>
<a id=__codelineno-11-30 name=__codelineno-11-30 href=#__codelineno-11-30></a><span class=kd>const</span><span class=w> </span><span class=nx>keyCache</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=ow>new</span><span class=w> </span><span class=nx>Type42KeyCache</span><span class=p>(</span><span class=nx>alice</span><span class=p>)</span>
<a id=__codelineno-11-31 name=__codelineno-11-31 href=#__codelineno-11-31></a>
<a id=__codelineno-11-32 name=__codelineno-11-32 href=#__codelineno-11-32></a><span class=kd>const</span><span class=w> </span><span class=nx>bob</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>PrivateKey</span><span class=p>.</span><span class=nx>fromRandom</span><span class=p>()</span>
<a id=__codelineno-11-33 name=__codelineno-11-33 href=#__codelineno-11-33></a><span class=kd>const</span><span class=w> </span><span class=nx>bobPub</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>bob</span><span class=p>.</span><span class=nx>toPublicKey</span><span class=p>()</span>
<a id=__codelineno-11-34 name=__codelineno-11-34 href=#__codelineno-11-34></a>
<a id=__codelineno-11-35 name=__codelineno-11-35 href=#__codelineno-11-35></a><span class=c1>// First call performs derivation</span>
<a id=__codelineno-11-36 name=__codelineno-11-36 href=#__codelineno-11-36></a><span class=kd>const</span><span class=w> </span><span class=nx>key1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>keyCache</span><span class=p>.</span><span class=nx>deriveKey</span><span class=p>(</span><span class=nx>bobPub</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;2-cached-001&#39;</span><span class=p>)</span>
<a id=__codelineno-11-37 name=__codelineno-11-37 href=#__codelineno-11-37></a>
<a id=__codelineno-11-38 name=__codelineno-11-38 href=#__codelineno-11-38></a><span class=c1>// Second call uses cache</span>
<a id=__codelineno-11-39 name=__codelineno-11-39 href=#__codelineno-11-39></a><span class=kd>const</span><span class=w> </span><span class=nx>key2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>keyCache</span><span class=p>.</span><span class=nx>deriveKey</span><span class=p>(</span><span class=nx>bobPub</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;2-cached-001&#39;</span><span class=p>)</span>
<a id=__codelineno-11-40 name=__codelineno-11-40 href=#__codelineno-11-40></a>
<a id=__codelineno-11-41 name=__codelineno-11-41 href=#__codelineno-11-41></a><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;Keys are identical:&#39;</span><span class=p>,</span><span class=w> </span><span class=nx>key1</span><span class=p>.</span><span class=nx>toHex</span><span class=p>()</span><span class=w> </span><span class=o>===</span><span class=w> </span><span class=nx>key2</span><span class=p>.</span><span class=nx>toHex</span><span class=p>())</span>
<a id=__codelineno-11-42 name=__codelineno-11-42 href=#__codelineno-11-42></a><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;Cache size:&#39;</span><span class=p>,</span><span class=w> </span><span class=nx>keyCache</span><span class=p>.</span><span class=nx>getCacheSize</span><span class=p>())</span>
</code></pre></div> <h2 id=security-best-practices>Security Best Practices</h2> <h3 id=1-invoice-number-guidelines>1. Invoice Number Guidelines</h3> <div class=highlight><pre><span></span><code><a id=__codelineno-12-1 name=__codelineno-12-1 href=#__codelineno-12-1></a><span class=c1>// Good: Structured, unique invoice numbers</span>
<a id=__codelineno-12-2 name=__codelineno-12-2 href=#__codelineno-12-2></a><span class=kd>const</span><span class=w> </span><span class=nx>goodInvoiceNumbers</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[</span>
<a id=__codelineno-12-3 name=__codelineno-12-3 href=#__codelineno-12-3></a><span class=w>  </span><span class=s1>&#39;2-payment-20241210-001&#39;</span><span class=p>,</span>
<a id=__codelineno-12-4 name=__codelineno-12-4 href=#__codelineno-12-4></a><span class=w>  </span><span class=s1>&#39;2-message-session-abc123&#39;</span><span class=p>,</span>
<a id=__codelineno-12-5 name=__codelineno-12-5 href=#__codelineno-12-5></a><span class=w>  </span><span class=s1>&#39;2-auth-token-xyz789&#39;</span>
<a id=__codelineno-12-6 name=__codelineno-12-6 href=#__codelineno-12-6></a><span class=p>]</span>
<a id=__codelineno-12-7 name=__codelineno-12-7 href=#__codelineno-12-7></a>
<a id=__codelineno-12-8 name=__codelineno-12-8 href=#__codelineno-12-8></a><span class=c1>// Avoid: Predictable or reused invoice numbers</span>
<a id=__codelineno-12-9 name=__codelineno-12-9 href=#__codelineno-12-9></a><span class=kd>const</span><span class=w> </span><span class=nx>badInvoiceNumbers</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[</span>
<a id=__codelineno-12-10 name=__codelineno-12-10 href=#__codelineno-12-10></a><span class=w>  </span><span class=s1>&#39;1&#39;</span><span class=p>,</span><span class=w> </span><span class=c1>// Too simple</span>
<a id=__codelineno-12-11 name=__codelineno-12-11 href=#__codelineno-12-11></a><span class=w>  </span><span class=s1>&#39;payment&#39;</span><span class=p>,</span><span class=w> </span><span class=c1>// Not unique</span>
<a id=__codelineno-12-12 name=__codelineno-12-12 href=#__codelineno-12-12></a><span class=w>  </span><span class=s1>&#39;2-payment-001&#39;</span><span class=w> </span><span class=c1>// Reused across different contexts</span>
<a id=__codelineno-12-13 name=__codelineno-12-13 href=#__codelineno-12-13></a><span class=p>]</span>
</code></pre></div> <h3 id=2-master-key-protection>2. Master Key Protection</h3> <div class=highlight><pre><span></span><code><a id=__codelineno-13-1 name=__codelineno-13-1 href=#__codelineno-13-1></a><span class=kd>function</span><span class=w> </span><span class=nx>secureMasterKeyUsage</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-13-2 name=__codelineno-13-2 href=#__codelineno-13-2></a><span class=w>  </span><span class=c1>// Generate master key securely</span>
<a id=__codelineno-13-3 name=__codelineno-13-3 href=#__codelineno-13-3></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>masterKey</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>PrivateKey</span><span class=p>.</span><span class=nx>fromRandom</span><span class=p>()</span>
<a id=__codelineno-13-4 name=__codelineno-13-4 href=#__codelineno-13-4></a>
<a id=__codelineno-13-5 name=__codelineno-13-5 href=#__codelineno-13-5></a><span class=w>  </span><span class=c1>// Never log or expose master keys</span>
<a id=__codelineno-13-6 name=__codelineno-13-6 href=#__codelineno-13-6></a><span class=w>  </span><span class=c1>// console.log(&#39;Master key:&#39;, masterKey.toHex()) // DON&#39;T DO THIS</span>
<a id=__codelineno-13-7 name=__codelineno-13-7 href=#__codelineno-13-7></a>
<a id=__codelineno-13-8 name=__codelineno-13-8 href=#__codelineno-13-8></a><span class=w>  </span><span class=c1>// Use derived keys for operations</span>
<a id=__codelineno-13-9 name=__codelineno-13-9 href=#__codelineno-13-9></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>counterparty</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>PrivateKey</span><span class=p>.</span><span class=nx>fromRandom</span><span class=p>().</span><span class=nx>toPublicKey</span><span class=p>()</span>
<a id=__codelineno-13-10 name=__codelineno-13-10 href=#__codelineno-13-10></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>derivedKey</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>masterKey</span><span class=p>.</span><span class=nx>deriveChild</span><span class=p>(</span><span class=nx>counterparty</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;2-secure-operation-001&#39;</span><span class=p>)</span>
<a id=__codelineno-13-11 name=__codelineno-13-11 href=#__codelineno-13-11></a>
<a id=__codelineno-13-12 name=__codelineno-13-12 href=#__codelineno-13-12></a><span class=w>  </span><span class=c1>// Log derived keys if needed (they don&#39;t reveal master key)</span>
<a id=__codelineno-13-13 name=__codelineno-13-13 href=#__codelineno-13-13></a><span class=w>  </span><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;Derived key (safe to log):&#39;</span><span class=p>,</span><span class=w> </span><span class=nx>derivedKey</span><span class=p>.</span><span class=nx>toHex</span><span class=p>().</span><span class=nx>substring</span><span class=p>(</span><span class=mf>0</span><span class=p>,</span><span class=w> </span><span class=mf>16</span><span class=p>)</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s1>&#39;...&#39;</span><span class=p>)</span>
<a id=__codelineno-13-14 name=__codelineno-13-14 href=#__codelineno-13-14></a>
<a id=__codelineno-13-15 name=__codelineno-13-15 href=#__codelineno-13-15></a><span class=w>  </span><span class=k>return</span><span class=w> </span><span class=nx>derivedKey</span>
<a id=__codelineno-13-16 name=__codelineno-13-16 href=#__codelineno-13-16></a><span class=p>}</span>
</code></pre></div> <h3 id=3-counterparty-validation>3. Counterparty Validation</h3> <div class=highlight><pre><span></span><code><a id=__codelineno-14-1 name=__codelineno-14-1 href=#__codelineno-14-1></a><span class=kd>function</span><span class=w> </span><span class=nx>validateCounterparty</span><span class=p>(</span><span class=nx>publicKey</span><span class=o>:</span><span class=w> </span><span class=kt>PublicKey</span><span class=p>)</span><span class=o>:</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-14-2 name=__codelineno-14-2 href=#__codelineno-14-2></a><span class=w>  </span><span class=k>try</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-14-3 name=__codelineno-14-3 href=#__codelineno-14-3></a><span class=w>    </span><span class=c1>// Ensure the public key is valid by checking its coordinates</span>
<a id=__codelineno-14-4 name=__codelineno-14-4 href=#__codelineno-14-4></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>x</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>publicKey</span><span class=p>.</span><span class=nx>x</span>
<a id=__codelineno-14-5 name=__codelineno-14-5 href=#__codelineno-14-5></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>y</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>publicKey</span><span class=p>.</span><span class=nx>y</span>
<a id=__codelineno-14-6 name=__codelineno-14-6 href=#__codelineno-14-6></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=nx>x</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=o>!</span><span class=nx>y</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-14-7 name=__codelineno-14-7 href=#__codelineno-14-7></a><span class=w>      </span><span class=k>return</span><span class=w> </span><span class=kc>false</span>
<a id=__codelineno-14-8 name=__codelineno-14-8 href=#__codelineno-14-8></a><span class=w>    </span><span class=p>}</span>
<a id=__codelineno-14-9 name=__codelineno-14-9 href=#__codelineno-14-9></a>
<a id=__codelineno-14-10 name=__codelineno-14-10 href=#__codelineno-14-10></a><span class=w>    </span><span class=c1>// Additional validation can be added here</span>
<a id=__codelineno-14-11 name=__codelineno-14-11 href=#__codelineno-14-11></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=kc>true</span>
<a id=__codelineno-14-12 name=__codelineno-14-12 href=#__codelineno-14-12></a><span class=w>  </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=nx>error</span><span class=o>:</span><span class=w> </span><span class=kt>any</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-14-13 name=__codelineno-14-13 href=#__codelineno-14-13></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=kc>false</span>
<a id=__codelineno-14-14 name=__codelineno-14-14 href=#__codelineno-14-14></a><span class=w>  </span><span class=p>}</span>
<a id=__codelineno-14-15 name=__codelineno-14-15 href=#__codelineno-14-15></a><span class=p>}</span>
</code></pre></div> <h2 id=testing-type-42-implementation>Testing Type-42 Implementation</h2> <div class=highlight><pre><span></span><code><a id=__codelineno-15-1 name=__codelineno-15-1 href=#__codelineno-15-1></a><span class=kd>function</span><span class=w> </span><span class=nx>testType42Implementation</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-15-2 name=__codelineno-15-2 href=#__codelineno-15-2></a><span class=w>  </span><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;Testing Type-42 key derivation...&#39;</span><span class=p>)</span>
<a id=__codelineno-15-3 name=__codelineno-15-3 href=#__codelineno-15-3></a>
<a id=__codelineno-15-4 name=__codelineno-15-4 href=#__codelineno-15-4></a><span class=w>  </span><span class=c1>// Test 1: Basic derivation</span>
<a id=__codelineno-15-5 name=__codelineno-15-5 href=#__codelineno-15-5></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>alice</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>PrivateKey</span><span class=p>.</span><span class=nx>fromRandom</span><span class=p>()</span>
<a id=__codelineno-15-6 name=__codelineno-15-6 href=#__codelineno-15-6></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>bob</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>PrivateKey</span><span class=p>.</span><span class=nx>fromRandom</span><span class=p>()</span>
<a id=__codelineno-15-7 name=__codelineno-15-7 href=#__codelineno-15-7></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>bobPub</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>bob</span><span class=p>.</span><span class=nx>toPublicKey</span><span class=p>()</span>
<a id=__codelineno-15-8 name=__codelineno-15-8 href=#__codelineno-15-8></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>alicePub</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>alice</span><span class=p>.</span><span class=nx>toPublicKey</span><span class=p>()</span>
<a id=__codelineno-15-9 name=__codelineno-15-9 href=#__codelineno-15-9></a>
<a id=__codelineno-15-10 name=__codelineno-15-10 href=#__codelineno-15-10></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>invoiceNumber</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;2-test-001&#39;</span>
<a id=__codelineno-15-11 name=__codelineno-15-11 href=#__codelineno-15-11></a>
<a id=__codelineno-15-12 name=__codelineno-15-12 href=#__codelineno-15-12></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>aliceChild</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>alice</span><span class=p>.</span><span class=nx>deriveChild</span><span class=p>(</span><span class=nx>bobPub</span><span class=p>,</span><span class=w> </span><span class=nx>invoiceNumber</span><span class=p>)</span>
<a id=__codelineno-15-13 name=__codelineno-15-13 href=#__codelineno-15-13></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>aliceChildPub</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>alicePub</span><span class=p>.</span><span class=nx>deriveChild</span><span class=p>(</span><span class=nx>bob</span><span class=p>,</span><span class=w> </span><span class=nx>invoiceNumber</span><span class=p>)</span>
<a id=__codelineno-15-14 name=__codelineno-15-14 href=#__codelineno-15-14></a>
<a id=__codelineno-15-15 name=__codelineno-15-15 href=#__codelineno-15-15></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>test1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>aliceChild</span><span class=p>.</span><span class=nx>toPublicKey</span><span class=p>().</span><span class=nx>toString</span><span class=p>()</span><span class=w> </span><span class=o>===</span><span class=w> </span><span class=nx>aliceChildPub</span><span class=p>.</span><span class=nx>toString</span><span class=p>()</span>
<a id=__codelineno-15-16 name=__codelineno-15-16 href=#__codelineno-15-16></a><span class=w>  </span><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;Test 1 - Key consistency:&#39;</span><span class=p>,</span><span class=w> </span><span class=nx>test1</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=s1>&#39;PASS&#39;</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=s1>&#39;FAIL&#39;</span><span class=p>)</span>
<a id=__codelineno-15-17 name=__codelineno-15-17 href=#__codelineno-15-17></a>
<a id=__codelineno-15-18 name=__codelineno-15-18 href=#__codelineno-15-18></a><span class=w>  </span><span class=c1>// Test 2: Message signing and verification</span>
<a id=__codelineno-15-19 name=__codelineno-15-19 href=#__codelineno-15-19></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>message</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>Utils</span><span class=p>.</span><span class=nx>toArray</span><span class=p>(</span><span class=s1>&#39;Test message&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;utf8&#39;</span><span class=p>)</span>
<a id=__codelineno-15-20 name=__codelineno-15-20 href=#__codelineno-15-20></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>signature</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>aliceChild</span><span class=p>.</span><span class=nx>sign</span><span class=p>(</span><span class=nx>message</span><span class=p>)</span>
<a id=__codelineno-15-21 name=__codelineno-15-21 href=#__codelineno-15-21></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>verified</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>aliceChildPub</span><span class=p>.</span><span class=nx>verify</span><span class=p>(</span><span class=nx>message</span><span class=p>,</span><span class=w> </span><span class=nx>signature</span><span class=p>)</span>
<a id=__codelineno-15-22 name=__codelineno-15-22 href=#__codelineno-15-22></a>
<a id=__codelineno-15-23 name=__codelineno-15-23 href=#__codelineno-15-23></a><span class=w>  </span><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;Test 2 - Sign/verify:&#39;</span><span class=p>,</span><span class=w> </span><span class=nx>verified</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=s1>&#39;PASS&#39;</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=s1>&#39;FAIL&#39;</span><span class=p>)</span>
<a id=__codelineno-15-24 name=__codelineno-15-24 href=#__codelineno-15-24></a>
<a id=__codelineno-15-25 name=__codelineno-15-25 href=#__codelineno-15-25></a><span class=w>  </span><span class=c1>// Test 3: Different invoice numbers produce different keys</span>
<a id=__codelineno-15-26 name=__codelineno-15-26 href=#__codelineno-15-26></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>key1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>alice</span><span class=p>.</span><span class=nx>deriveChild</span><span class=p>(</span><span class=nx>bobPub</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;2-test-001&#39;</span><span class=p>)</span>
<a id=__codelineno-15-27 name=__codelineno-15-27 href=#__codelineno-15-27></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>key2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>alice</span><span class=p>.</span><span class=nx>deriveChild</span><span class=p>(</span><span class=nx>bobPub</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;2-test-002&#39;</span><span class=p>)</span>
<a id=__codelineno-15-28 name=__codelineno-15-28 href=#__codelineno-15-28></a>
<a id=__codelineno-15-29 name=__codelineno-15-29 href=#__codelineno-15-29></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>test3</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>key1</span><span class=p>.</span><span class=nx>toHex</span><span class=p>()</span><span class=w> </span><span class=o>!==</span><span class=w> </span><span class=nx>key2</span><span class=p>.</span><span class=nx>toHex</span><span class=p>()</span>
<a id=__codelineno-15-30 name=__codelineno-15-30 href=#__codelineno-15-30></a><span class=w>  </span><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;Test 3 - Unique keys:&#39;</span><span class=p>,</span><span class=w> </span><span class=nx>test3</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=s1>&#39;PASS&#39;</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=s1>&#39;FAIL&#39;</span><span class=p>)</span>
<a id=__codelineno-15-31 name=__codelineno-15-31 href=#__codelineno-15-31></a>
<a id=__codelineno-15-32 name=__codelineno-15-32 href=#__codelineno-15-32></a><span class=w>  </span><span class=c1>// Test 4: Bidirectional derivation</span>
<a id=__codelineno-15-33 name=__codelineno-15-33 href=#__codelineno-15-33></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>bobChild</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>bob</span><span class=p>.</span><span class=nx>deriveChild</span><span class=p>(</span><span class=nx>alicePub</span><span class=p>,</span><span class=w> </span><span class=nx>invoiceNumber</span><span class=p>)</span>
<a id=__codelineno-15-34 name=__codelineno-15-34 href=#__codelineno-15-34></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>bobChildPub</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>bobPub</span><span class=p>.</span><span class=nx>deriveChild</span><span class=p>(</span><span class=nx>alice</span><span class=p>,</span><span class=w> </span><span class=nx>invoiceNumber</span><span class=p>)</span>
<a id=__codelineno-15-35 name=__codelineno-15-35 href=#__codelineno-15-35></a>
<a id=__codelineno-15-36 name=__codelineno-15-36 href=#__codelineno-15-36></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>test4</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>bobChild</span><span class=p>.</span><span class=nx>toPublicKey</span><span class=p>().</span><span class=nx>toString</span><span class=p>()</span><span class=w> </span><span class=o>===</span><span class=w> </span><span class=nx>bobChildPub</span><span class=p>.</span><span class=nx>toString</span><span class=p>()</span>
<a id=__codelineno-15-37 name=__codelineno-15-37 href=#__codelineno-15-37></a><span class=w>  </span><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;Test 4 - Bidirectional:&#39;</span><span class=p>,</span><span class=w> </span><span class=nx>test4</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=s1>&#39;PASS&#39;</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=s1>&#39;FAIL&#39;</span><span class=p>)</span>
<a id=__codelineno-15-38 name=__codelineno-15-38 href=#__codelineno-15-38></a>
<a id=__codelineno-15-39 name=__codelineno-15-39 href=#__codelineno-15-39></a><span class=w>  </span><span class=k>return</span><span class=w> </span><span class=nx>test1</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=nx>verified</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=nx>test3</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=nx>test4</span>
<a id=__codelineno-15-40 name=__codelineno-15-40 href=#__codelineno-15-40></a><span class=p>}</span>
<a id=__codelineno-15-41 name=__codelineno-15-41 href=#__codelineno-15-41></a>
<a id=__codelineno-15-42 name=__codelineno-15-42 href=#__codelineno-15-42></a><span class=c1>// Run tests</span>
<a id=__codelineno-15-43 name=__codelineno-15-43 href=#__codelineno-15-43></a><span class=kd>const</span><span class=w> </span><span class=nx>allTestsPassed</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>testType42Implementation</span><span class=p>()</span>
<a id=__codelineno-15-44 name=__codelineno-15-44 href=#__codelineno-15-44></a><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;All tests passed:&#39;</span><span class=p>,</span><span class=w> </span><span class=nx>allTestsPassed</span><span class=p>)</span>
</code></pre></div> <h2 id=troubleshooting-common-issues>Troubleshooting Common Issues</h2> <h3 id=issue-1-key-mismatch>Issue 1: Key Mismatch</h3> <div class=highlight><pre><span></span><code><a id=__codelineno-16-1 name=__codelineno-16-1 href=#__codelineno-16-1></a><span class=c1>// Problem: Derived keys don&#39;t match</span>
<a id=__codelineno-16-2 name=__codelineno-16-2 href=#__codelineno-16-2></a><span class=c1>// Solution: Ensure consistent invoice numbers and key order</span>
<a id=__codelineno-16-3 name=__codelineno-16-3 href=#__codelineno-16-3></a>
<a id=__codelineno-16-4 name=__codelineno-16-4 href=#__codelineno-16-4></a><span class=kd>function</span><span class=w> </span><span class=nx>debugKeyMismatch</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-16-5 name=__codelineno-16-5 href=#__codelineno-16-5></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>alice</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>PrivateKey</span><span class=p>.</span><span class=nx>fromRandom</span><span class=p>()</span>
<a id=__codelineno-16-6 name=__codelineno-16-6 href=#__codelineno-16-6></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>bob</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>PrivateKey</span><span class=p>.</span><span class=nx>fromRandom</span><span class=p>()</span>
<a id=__codelineno-16-7 name=__codelineno-16-7 href=#__codelineno-16-7></a>
<a id=__codelineno-16-8 name=__codelineno-16-8 href=#__codelineno-16-8></a><span class=w>  </span><span class=c1>// Wrong: Different invoice numbers</span>
<a id=__codelineno-16-9 name=__codelineno-16-9 href=#__codelineno-16-9></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>key1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>alice</span><span class=p>.</span><span class=nx>deriveChild</span><span class=p>(</span><span class=nx>bob</span><span class=p>.</span><span class=nx>toPublicKey</span><span class=p>(),</span><span class=w> </span><span class=s1>&#39;2-test-001&#39;</span><span class=p>)</span>
<a id=__codelineno-16-10 name=__codelineno-16-10 href=#__codelineno-16-10></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>key2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>alice</span><span class=p>.</span><span class=nx>toPublicKey</span><span class=p>().</span><span class=nx>deriveChild</span><span class=p>(</span><span class=nx>bob</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;2-test-002&#39;</span><span class=p>)</span><span class=w> </span><span class=c1>// Different number</span>
<a id=__codelineno-16-11 name=__codelineno-16-11 href=#__codelineno-16-11></a>
<a id=__codelineno-16-12 name=__codelineno-16-12 href=#__codelineno-16-12></a><span class=w>  </span><span class=c1>// Correct: Same invoice number</span>
<a id=__codelineno-16-13 name=__codelineno-16-13 href=#__codelineno-16-13></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>key3</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>alice</span><span class=p>.</span><span class=nx>deriveChild</span><span class=p>(</span><span class=nx>bob</span><span class=p>.</span><span class=nx>toPublicKey</span><span class=p>(),</span><span class=w> </span><span class=s1>&#39;2-test-001&#39;</span><span class=p>)</span>
<a id=__codelineno-16-14 name=__codelineno-16-14 href=#__codelineno-16-14></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>key4</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>alice</span><span class=p>.</span><span class=nx>toPublicKey</span><span class=p>().</span><span class=nx>deriveChild</span><span class=p>(</span><span class=nx>bob</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;2-test-001&#39;</span><span class=p>)</span><span class=w> </span><span class=c1>// Same number</span>
<a id=__codelineno-16-15 name=__codelineno-16-15 href=#__codelineno-16-15></a>
<a id=__codelineno-16-16 name=__codelineno-16-16 href=#__codelineno-16-16></a><span class=w>  </span><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;Wrong approach - keys match:&#39;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-16-17 name=__codelineno-16-17 href=#__codelineno-16-17></a><span class=w>    </span><span class=nx>key1</span><span class=p>.</span><span class=nx>toPublicKey</span><span class=p>().</span><span class=nx>toString</span><span class=p>()</span><span class=w> </span><span class=o>===</span><span class=w> </span><span class=nx>key2</span><span class=p>.</span><span class=nx>toString</span><span class=p>())</span>
<a id=__codelineno-16-18 name=__codelineno-16-18 href=#__codelineno-16-18></a><span class=w>  </span><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;Correct approach - keys match:&#39;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-16-19 name=__codelineno-16-19 href=#__codelineno-16-19></a><span class=w>    </span><span class=nx>key3</span><span class=p>.</span><span class=nx>toPublicKey</span><span class=p>().</span><span class=nx>toString</span><span class=p>()</span><span class=w> </span><span class=o>===</span><span class=w> </span><span class=nx>key4</span><span class=p>.</span><span class=nx>toString</span><span class=p>())</span>
<a id=__codelineno-16-20 name=__codelineno-16-20 href=#__codelineno-16-20></a><span class=p>}</span>
</code></pre></div> <h3 id=issue-2-invalid-public-key>Issue 2: Invalid Public Key</h3> <div class=highlight><pre><span></span><code><a id=__codelineno-17-1 name=__codelineno-17-1 href=#__codelineno-17-1></a><span class=kd>function</span><span class=w> </span><span class=nx>handleInvalidPublicKey</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-17-2 name=__codelineno-17-2 href=#__codelineno-17-2></a><span class=w>  </span><span class=k>try</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-17-3 name=__codelineno-17-3 href=#__codelineno-17-3></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>alice</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>PrivateKey</span><span class=p>.</span><span class=nx>fromRandom</span><span class=p>()</span>
<a id=__codelineno-17-4 name=__codelineno-17-4 href=#__codelineno-17-4></a><span class=w>    </span><span class=c1>// This would cause an error if publicKey is invalid</span>
<a id=__codelineno-17-5 name=__codelineno-17-5 href=#__codelineno-17-5></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>invalidPub</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=kr>as</span><span class=w> </span><span class=nx>any</span>
<a id=__codelineno-17-6 name=__codelineno-17-6 href=#__codelineno-17-6></a>
<a id=__codelineno-17-7 name=__codelineno-17-7 href=#__codelineno-17-7></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>derivedKey</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>alice</span><span class=p>.</span><span class=nx>deriveChild</span><span class=p>(</span><span class=nx>invalidPub</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;2-test-001&#39;</span><span class=p>)</span>
<a id=__codelineno-17-8 name=__codelineno-17-8 href=#__codelineno-17-8></a><span class=w>  </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=nx>error</span><span class=o>:</span><span class=w> </span><span class=kt>any</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-17-9 name=__codelineno-17-9 href=#__codelineno-17-9></a><span class=w>    </span><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;Caught invalid public key error:&#39;</span><span class=p>,</span><span class=w> </span><span class=nx>error</span><span class=p>.</span><span class=nx>message</span><span class=p>)</span>
<a id=__codelineno-17-10 name=__codelineno-17-10 href=#__codelineno-17-10></a><span class=w>    </span><span class=c1>// Handle the error appropriately</span>
<a id=__codelineno-17-11 name=__codelineno-17-11 href=#__codelineno-17-11></a><span class=w>  </span><span class=p>}</span>
<a id=__codelineno-17-12 name=__codelineno-17-12 href=#__codelineno-17-12></a><span class=p>}</span>
</code></pre></div> <h2 id=conclusion>Conclusion</h2> <p>Type-42 key derivation provides a powerful mechanism for creating shared key universes between two parties. You've learned how to:</p> <ul> <li>Generate master keys and derive child keys using invoice numbers</li> <li>Implement secure message signing and verification</li> <li>Use the "anyone key" for publicly verifiable signatures</li> <li>Apply Type-42 in various Bitcoin applications</li> <li>Handle errors and optimize performance</li> <li>Follow security best practices</li> </ul> <p>Type-42 enables sophisticated cryptographic protocols while maintaining the security properties of elliptic curve cryptography. The derived keys are unlinkable to master keys by outside parties, providing privacy and security for Bitcoin applications.</p> <h2 id=further-reading>Further Reading</h2> <ul> <li><a href=../ecdh-key-exchange/ >ECDH Key Exchange Tutorial</a></li> <li><a href=../elliptic-curve-fundamentals/ >Elliptic Curve Fundamentals Tutorial</a></li> <li><a href=https://docs.bsvblockchain.org/guides/sdks/ts/low-level/type_42>BSV Type-42 Documentation</a></li> <li><a href=../../reference/messages/ >Messages Reference</a></li> </ul> <h2 id=integration-with-walletclient>Integration with <code>WalletClient</code></h2> <p>For production applications, the <code>WalletClient</code> provides secure key management for Type-42 operations:</p> <p>```typescript // Usage example const walletClient = new WalletClient('https://api.bsvwallet.com/v1') const alice = walletClient.getPrivateKey('alice') const bob = walletClient.getPrivateKey('bob') const invoiceNumber = '2-secure-operation-001'</p> <p>const derivedKey = alice.deriveChild(bob.toPublicKey(), invoiceNumber) console.log('Derived key:', derivedKey.toHex().substring(0, 16) + '...')</p> </article> </div> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> <button type=button class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg> Back to top </button> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../..", "features": ["navigation.instant", "navigation.tracking", "navigation.expand", "navigation.indexes", "navigation.top", "search.highlight", "search.share", "content.code.copy"], "search": "../../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script> <script src=../../assets/javascripts/bundle.56ea9cef.min.js></script> </body> </html>